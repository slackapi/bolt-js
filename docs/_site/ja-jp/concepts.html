<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
  
    <title>Slack | Bolt for JavaScript</title>
    <meta name="author" content="Slack">
    <meta name="description" content="A framework that makes Slack app development fast and straight-forward. With a single interface for Slack’s Web API, Events API, and interactive features, Bolt gives you the full power of the Slack platform out of the box.">
    <link rel="canonical" href="http://localhost:4000/bolt-js/ja-jp/concepts">
    <link href="https://a.slack-edge.com/17c88/style/rollup-slack_kit_legacy_adapters.css" rel="stylesheet" type="text/css">
    <link href="https://a.slack-edge.com/cc5205/style/rollup-api_site.css" rel="stylesheet" type="text/css">
    
      <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP:400,700&display=swap" rel="stylesheet">
    
    <link href="http://localhost:4000/bolt-js/assets/style.css" rel="stylesheet" type="text/css">
  
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    

    <!--[if lt IE 9]>
    <script src="https://a.slack-edge.com/ef0d/js/libs/html5shiv.js"></script>
    <![endif]-->
  
    <link id="favicon" rel="shortcut icon" href="http://localhost:4000/bolt-js/assets/bolt-favicon.png" sizes="16x16 32x32 48x48" type="image/png" />
  
  </head>


  <body>
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KFZ5MK7');</script>
<!-- End Google Tag Manager -->

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KFZ5MK7" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

    <div class="wrapper">
      <div class="panel">
        <div class="sidebar-content">
  <div class="logo">
    <span class="icon">
      <img src="http://localhost:4000/bolt-js/assets/bolt-js-logo.svg">
    </span>

    <span class="name">
      Bolt
    </span>

    <!-- Liquid has no ternary operator, so this is just meant to exclude 
      english sections since they are at the root URL -->
    

    <span class="version">
      
      <a href="https://github.com/slackapi/bolt-js/releases/tag/%40slack/bolt%403.18.0">v3.18.0</a>
    </span>
  </div>

  <ul class="sidebar-section">
    <a href="http://localhost:4000/bolt-js/ja-jp/tutorial/getting-started"><li class="title">Bolt 入門ガイド</li></a>
    <a href="http://localhost:4000/bolt-js/ja-jp/reference"><li class="title">リファレンス</li></a>
  </ul>

  <ul class="sidebar-section">
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#basic"><li class="title">基本的な概念</li></a>
     
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#message-listening">
      <li>メッセージ・イベントのリスニング</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#message-sending">
      <li>メッセージの送信</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#event-listening">
      <li>イベントのリスニング</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#web-api">
      <li>Web API の使用</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#action-listening">
      <li>アクションのリスニング</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#action-respond">
      <li>アクションへの応答</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#acknowledge">
      <li>リクエストの確認</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#shortcuts">
      <li>ショートカットのリスニング</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#commands">
      <li>コマンドのリスニングと応答</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#creating-modals">
      <li>モーダルの開始</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#updating-pushing-views">
      <li>モーダルの更新と多重表示</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#view-submissions">
      <li>モーダルでの送信のリスニング</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#publishing-views">
      <li>ホームタブの更新</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#options">
      <li>オプションのリスニングと応答</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#authenticating-oauth">
      <li>OAuth フローの実装</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#socket-mode">
      <li>ソケットモードの使用</li>
    </a>
    
  </ul>

  <ul class="sidebar-section">
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#advanced">
      <li class="title">応用コンセプト</li>
    </a>
     
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#error-handling">
      <li>エラーの処理</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#authorization">
      <li>認可（Authorization）</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#token-rotation">
      <li>トークンのローテーション</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#conversation-store">
      <li>会話ストア</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#global-middleware">
      <li>グローバルミドルウェア</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#listener-middleware">
      <li>リスナーミドルウェア</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#context">
      <li>context の追加</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#logging">
      <li>ログの表示</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#receiver">
      <li>レシーバーのカスタマイズ</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#custom-routes">
      <li>カスタム HTTP ルートの追加</li>
    </a>
    
  </ul>

  
  
    <ul class="sidebar-section"> 
        <li class="title">Deployments</li>
      
        <a href="http://localhost:4000/bolt-js/ja-jp/deployments/aws-lambda">
          <li>AWS Lambda へのデプロイ</li>
        </a>
      
        <a href="http://localhost:4000/bolt-js/ja-jp/deployments/heroku">
          <li>Heroku へのデプロイ</li>
        </a>
      
    </ul>
  

  <ul class="sidebar-section">
    <a href="http://localhost:4000/bolt-js/ja-jp/concepts#steps">
      <li class="title">
        ワークフローステップ
        <span class="label-deprecated">
          非推奨
        </span>
      </li>
    </a>
     
      
    
      
      <a href="http://localhost:4000/bolt-js/ja-jp/concepts#creating-steps">
        
        <!--UNCOMMENT AFTER GA  -->
        <li>
          ステップの定義
        </li>
      </a>
      
    
      
      <a href="http://localhost:4000/bolt-js/ja-jp/concepts#adding-editing-steps">
        
        <!--UNCOMMENT AFTER GA  -->
        <li>
          ステップの追加・編集
        </li>
      </a>
      
    
      
      <a href="http://localhost:4000/bolt-js/ja-jp/concepts#saving-steps">
        
        <!--UNCOMMENT AFTER GA  -->
        <li>
          ステップの設定の保存
        </li>
      </a>
      
    
      
      <a href="http://localhost:4000/bolt-js/ja-jp/concepts#executing-steps">
        
        <!--UNCOMMENT AFTER GA  -->
        <li>
          ステップの実行
        </li>
      </a>
      
    
  </ul>

  <ul class="sidebar-section">
    
    
    <a href="http://localhost:4000/bolt-js/ja-jp/tutorial/getting-started-http">
      <li class="title">Bolt 入門ガイド (HTTP)</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/tutorial/hubot-migration">
      <li class="title">Hubot から Bolt に移行する方法</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/tutorial/migration-v2">
      <li class="title">2.x マイグレーションガイド</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/tutorial/migration-v3">
      <li class="title">3.x マイグレーションガイド</li>
    </a>
    
    <a href="http://localhost:4000/bolt-js/ja-jp/tutorial/using-typescript">
      <li class="title">TypeScript での利用ガイド</li>
    </a>
    
    <a href="https://github.com/SlackAPI/bolt-js/blob/main/.github/contributing.md">
      <li class="title">貢献</li>
    </a>
  </ul>
</div>

      </div>

      <div class="content">
        <div class="mainheader">
          <div class="header">
  <div class="header_nav">
    <a href="https://github.com/SlackAPI/bolt-js" class="btn header_btn float_right"><ts-icon class="ts_icon_github"></ts-icon>Code on GitHub</a>
    <a href="https://api.slack.com" class="btn header_btn float_right"><ts-icon class="ts_icon_slack_pillow"></ts-icon>Slack Platform Home</a>
    <!-- If we add more languages, this logic will need to change -->
    
      <a href="http://localhost:4000/bolt-js/" class="header_btn language-switcher float_right">English</a>
    
    </div>
</div>
        </div>

        <div id="basic">
           
          <div class="section-wrapper">
            <h3 id="message-listening">メッセージ・イベントのリスニング</h3>

            <div class="section-content">
  <p><a href="https://api.slack.com/messaging/retrieving#permissions">アプリが受信可能な</a>メッセージをリッスンするには、<code class="language-plaintext highlighter-rouge">message</code> 型でないイベントを除外する <code class="language-plaintext highlighter-rouge">message()</code> メソッドを使用します。</p>

  <p><code class="language-plaintext highlighter-rouge">message()</code> は、<code class="language-plaintext highlighter-rouge">string</code> 型か <code class="language-plaintext highlighter-rouge">RegExp</code> 型の、指定パターンに一致しないメッセージを除外する <code class="language-plaintext highlighter-rouge">pattern</code> パラメーター（指定は必須ではありません）を受け付けます。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="rouge-code"><pre><span class="c1">// 特定の文字列、この場合 👋絵文字を含むメッセージと一致</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="dl">'</span><span class="s1">:wave:</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">say</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// 新しく投稿されたメッセージだけを処理</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">===</span> <span class="kc">undefined</span>
    <span class="o">||</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">bot_message</span><span class="dl">'</span>
    <span class="o">||</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">file_share</span><span class="dl">'</span>
    <span class="o">||</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">thread_broadcast</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">say</span><span class="p">(</span><span class="s2">`Hello, &lt;@</span><span class="p">${</span><span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="s2">&gt;`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">正規表現（RegExp） パターンの使用</h4>
  </summary>

  <div class="secondary-content">
    <p>文字列の代わりに 正規表現(RegExp) パターンを使用すると、より細やかなマッチングが可能です。</p>

    <p>RegExp の一致結果はすべて <code class="language-plaintext highlighter-rouge">context.matches</code> に保持されます。</p>
  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="sr">/^</span><span class="se">(</span><span class="sr">hi|hello|hey</span><span class="se">)</span><span class="sr">.*/</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">say</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// context.matches の内容が特定の正規表現と一致</span>
  <span class="kd">const</span> <span class="nx">greeting</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="k">await</span> <span class="nx">say</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">greeting</span><span class="p">}</span><span class="s2">, how are you?`</span><span class="p">);</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="message-sending">メッセージの送信</h3>

            <div class="section-content">
  <p>リスナー関数内では、その実行に関連付けられた会話 (例：リスナー実行のトリガーが発生したイベント・アクションが発生したチャンネル) があるとき <code class="language-plaintext highlighter-rouge">say()</code> を使用できます。 <code class="language-plaintext highlighter-rouge">say()</code> は、シンプルなメッセージを送信するための文字列か、もっと複雑なメッセージを送信するための JSON ペイロードを受け付けます。渡されたメッセージのペイロードは、関連付けられた会話へ送信されます。</p>

  <p>リスナー関数以外の場所でメッセージを送信したい場合や、より高度な操作 (特定のエラーの処理など) を実行したい場合は、<a href="#web-api">Bolt インスタンスにアタッチされた client を使用</a>して <code class="language-plaintext highlighter-rouge">chat.postMessage</code> を呼び出します。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="c1">// "knock knock" を含むメッセージをリッスンし、 "who's there?" というメッセージをイタリック体で送信</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="dl">'</span><span class="s1">knock knock</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">say</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">say</span><span class="p">(</span><span class="s2">`_Who's there?_`</span><span class="p">);</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary>
    <h4 class="secondary-header">ブロックを用いたメッセージの送信</h4>
  </summary>

  <div class="secondary-content">
    <p><code class="language-plaintext highlighter-rouge">say()</code> は、より複雑なメッセージペイロードを受け付けるので、メッセージに機能やリッチな構造を与えることが容易です。</p>

    <p>リッチなメッセージレイアウトをアプリに追加する方法については、<a href="https://api.slack.com/messaging/composing/layouts">API サイトのガイド</a>を参照し、<a href="https://api.slack.com/tools/block-kit-builder?template=1">Block Kit ビルダー</a>の一般的なアプリフローのテンプレートを確認してください。</p>
  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
<td class="rouge-code"><pre><span class="c1">// 誰かが 📅 絵文字でリアクションした時に、日付ピッカー block を送信</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="dl">'</span><span class="s1">reaction_added</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">say</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">reaction</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">calendar</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">say</span><span class="p">({</span>
      <span class="na">blocks</span><span class="p">:</span> <span class="p">[{</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">section</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mrkdwn</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Pick a date for me to remind you</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="dl">"</span><span class="s2">accessory</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">datepicker</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">action_id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">datepicker_remind</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">initial_date</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2019-04-28</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">placeholder</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">plain_text</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Select a date</span><span class="dl">"</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}]</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>
</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="event-listening">イベントのリスニング</h3>

            <div class="section-content">
  <p><a href="https://api.slack.com/events">Events API イベント</a>のリスニングは、Slack アプリの設定画面でサブスクリプション設定を行った上で <code class="language-plaintext highlighter-rouge">event()</code> メソッドを使用します。これにより、Slack で何かが発生した (例：ユーザーがメッセージにリアクションした、チャンネルに参加した) ときに Bolt アプリ側で処理を実行できます。</p>

  <p><code class="language-plaintext highlighter-rouge">event()</code> メソッドは、文字列型の <code class="language-plaintext highlighter-rouge">eventType</code> を指定する必要があります。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">welcomeChannelId</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">C12345</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// 新しいユーザーがワークスペースに加入したタイミングで、指定のチャンネルにメッセージを送信して自己紹介を促す</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="dl">'</span><span class="s1">team_join</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// 組み込みの client で chat.postMessage を呼び出す</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
      <span class="na">channel</span><span class="p">:</span> <span class="nx">welcomeChannelId</span><span class="p">,</span>
      <span class="na">text</span><span class="p">:</span> <span class="s2">`Welcome to the team, &lt;@</span><span class="p">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">&gt;! 🎉 You can introduce yourself in this channel.`</span>
    <span class="p">});</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">メッセージのサブタイプのフィルタリング</h4>
  </summary>

  <div class="secondary-content">
    <p><code class="language-plaintext highlighter-rouge">message()</code> リスナーは <code class="language-plaintext highlighter-rouge">event('message')</code> と等価の機能を提供します。</p>

    <p>イベントのサブタイプをフィルタリングしたい場合、組み込みの <code class="language-plaintext highlighter-rouge">subtype()</code> ミドルウェアを使用できます。 <code class="language-plaintext highlighter-rouge">message_changed</code> や <code class="language-plaintext highlighter-rouge">message_replied</code> のような一般的なメッセージサブタイプの情報は、<a href="https://api.slack.com/events/message#message_subtypes">メッセージイベントのドキュメント</a>を参照してください。</p>
  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
<td class="rouge-code"><pre><span class="c1">// パッケージから subtype をインポート</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">subtype</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// user からのメッセージの編集と一致</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="nx">subtype</span><span class="p">(</span><span class="dl">'</span><span class="s1">message_changed</span><span class="dl">'</span><span class="p">),</span> <span class="p">({</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// この if 文は TypeScript でコードを書く際に必要</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">message_changed</span><span class="dl">'</span>
    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span>
    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">previous_message</span><span class="p">.</span><span class="nx">subtype</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`The user </span><span class="p">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="s2"> changed their message from </span><span class="p">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">previous_message</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span><span class="s2"> to </span><span class="p">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="web-api">Web API の使用</h3>

            <div class="section-content">
  <p><a href="https://api.slack.com/methods">Web API メソッド</a>を呼び出すには、リスナー関数の引数に <code class="language-plaintext highlighter-rouge">client</code> として提供されている <a href="https://slack.dev/node-slack-sdk/web-api"><code class="language-plaintext highlighter-rouge">WebClient</code></a> を使用します。このインスタンスが使用するトークンは、Bolt アプリの初期化時に指定されたもの <b>もしくは</b> Slack からのリクエストに対して <a href="#authorization"><code class="language-plaintext highlighter-rouge">authorize</code> 関数</a>から返されたものが設定されます。組み込みの <a href="#authenticating-oauth">OAuth サポート</a>は、この後者のケースをデフォルトでハンドリングします。</p>

  <p>Bolt アプリケーションは、トップレベルに <code class="language-plaintext highlighter-rouge">app.client</code> も持っています。このインスタンスには、トークンをメソッド呼び出しのパラメーターとして都度指定します。Slack からのリクエストが authorize されないユースケースや、リスナー関数の外で Web API を呼び出したい場合は、このトップレベルの <code class="language-plaintext highlighter-rouge">app.client</code> を使用します。</p>

  <p>トップレベルのクライアントを使ってもリスナー関数でのクライアントを使っても、<a href="https://slack.dev/node-slack-sdk/web-api"><code class="language-plaintext highlighter-rouge">WebClient</code></a> が提供するメソッドを呼び出すと、それへの Slack からのレスポンスを含む Promise の値が返されます。</p>

  <p><a href="https://api.slack.com/enterprise/apps">OrG 全体へのインストール機能</a>の導入により、<a href="https://api.slack.com/enterprise/apps/changes-apis#methods">いくつかの Web API</a> は、動作しているワークスペースを伝えるために <code class="language-plaintext highlighter-rouge">team_id</code> パラメーターを必要とします。Bolt for JavaScript は、この <code class="language-plaintext highlighter-rouge">team_id</code> を Slack から受け取ったペイロードを元に判定し、<code class="language-plaintext highlighter-rouge">client</code> インスタンスに設定します。これは、既存のアプリケーションにとっても OrG 全体へのインストールに対応する上で有用です。既存の Web API 呼び出しの処理をアップデートする必要はありません。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
<td class="rouge-code"><pre><span class="c1">// September 30, 2019 11:59:59 PM を Unix エポックタイムで表示</span>
<span class="kd">const</span> <span class="nx">whenSeptemberEnds</span> <span class="o">=</span> <span class="mi">1569887999</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="dl">'</span><span class="s1">wake me up</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// トークンを用いて chat.scheduleMessage 関数を呼び出す</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">scheduleMessage</span><span class="p">({</span>
      <span class="c1">// アプリの初期化に用いたトークンを `context` オブジェクトに保存</span>
      <span class="na">token</span><span class="p">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">botToken</span><span class="p">,</span>
      <span class="na">channel</span><span class="p">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span><span class="p">,</span>
      <span class="na">post_at</span><span class="p">:</span> <span class="nx">whenSeptemberEnds</span><span class="p">,</span>
      <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Summer has come and passed</span><span class="dl">'</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="action-listening">アクションのリスニング</h3>

            <div class="section-content">
  <p>Bolt アプリは <code class="language-plaintext highlighter-rouge">action</code> メソッドを用いて、ボタンのクリック、メニューの選択、メッセージショートカットなどのユーザーのアクションをリッスンすることができます。</p>

  <p>アクションは文字列型の <code class="language-plaintext highlighter-rouge">action_id</code> または RegExp オブジェクトでフィルタリングできます。 <code class="language-plaintext highlighter-rouge">action_id</code> は、Slack プラットフォーム上のインタラクティブコンポーネントの一意の識別子として機能します。</p>

  <p>すべての <code class="language-plaintext highlighter-rouge">action()</code> の例で <code class="language-plaintext highlighter-rouge">ack()</code> が使用されていることに注目してください。Slack からリクエストを受信したことを確認するために、アクションリスナー内で <code class="language-plaintext highlighter-rouge">ack()</code> 関数を呼び出す必要があります。これについては、「<a href="#acknowledge">リクエストの確認</a>」 セクションで説明しています。</p>

  <p><em>注: Bolt 2.x からメッセージショートカット（以前はメッセージアクションと呼ばれていました）は <code class="language-plaintext highlighter-rouge">action()</code> ではなく <code class="language-plaintext highlighter-rouge">shortcut()</code> メソッドを使用するようになりました。この変更については <a href="https://slack.dev/bolt/ja-jp/tutorial/migration-v2">2.x マイグレーションガイド</a>を参照してください。</em></p>

  <p><code class="language-plaintext highlighter-rouge">block_actions</code> ペイロードの詳細については、<a href="https://api.slack.com/reference/interaction-payloads">こちら</a> をご覧ください。リスナー内からビューの完全なペイロードにアクセスするには、コールバック関数内で <code class="language-plaintext highlighter-rouge">body</code> 引数を参照します。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="c1">// action_id が "approve_button" のインタラクティブコンポーネントがトリガーされる毎にミドルウェアが呼び出される</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="dl">'</span><span class="s1">approve_button</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>
  <span class="c1">// アクションを反映してメッセージをアップデート</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">制約付きオブジェクトを使用したアクションのリスニング</h4>
  </summary>

  <div class="secondary-content">
    <p>制約付きのオブジェクトを使って、 <code class="language-plaintext highlighter-rouge">callback_id</code> 、 <code class="language-plaintext highlighter-rouge">block_id</code> 、および <code class="language-plaintext highlighter-rouge">action_id</code> (またはそれらの組み合わせ) をリッスンすることができます。オブジェクト内の制約には、文字列型または RegExp オブジェクトを使用できます。</p>
  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
<td class="rouge-code"><pre><span class="c1">// action_id が 'select_user' と一致し、block_id が 'assign_ticket' と一致する場合のみミドルウェアが呼び出される</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">action</span><span class="p">({</span> <span class="na">action_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">select_user</span><span class="dl">'</span><span class="p">,</span> <span class="na">block_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">assign_ticket</span><span class="dl">'</span> <span class="p">},</span>
  <span class="k">async</span> <span class="p">({</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">reactions</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
          <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">white_check_mark</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">timestamp</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">ts</span><span class="p">,</span>
          <span class="na">channel</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">id</span>
        <span class="p">});</span>

        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="action-respond">アクションへの応答</h3>

            <div class="section-content">
  <p>アクションへの応答には、主に 2 つのやり方があります。1 つ目の (最も一般的な) やり方は <code class="language-plaintext highlighter-rouge">say</code> 関数の利用です。 <code class="language-plaintext highlighter-rouge">say</code> 関数は、Slack 内のリクエストが発生した会話（チャンネルや DM）へメッセージを返します。</p>

  <p>アクションに応答する 2 つ目の方法は <code class="language-plaintext highlighter-rouge">respond()</code> です。これはアクションに紐付けられている <code class="language-plaintext highlighter-rouge">response_url</code> を用いたメッセージの送信をシンプルに行うためのユーティリティです。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="c1">// action_id が "approve_button" のインタラクティブコンポーネントがトリガーされる毎にミドルウェアが呼び出される</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="dl">'</span><span class="s1">approve_button</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">say</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// アクションリクエストの確認</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>
  <span class="k">await</span> <span class="nx">say</span><span class="p">(</span><span class="dl">'</span><span class="s1">Request approved 👍</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">respond() の使用</h4>
  </summary>

  <div class="secondary-content">
    <p><code class="language-plaintext highlighter-rouge">respond()</code> は <code class="language-plaintext highlighter-rouge">response_url</code> を呼び出すためのユーティリティであるため、それを直接使うときと同様に動作します。新しいメッセージのペイロードと、オプショナルな引数である <code class="language-plaintext highlighter-rouge">response_type</code> (値は <code class="language-plaintext highlighter-rouge">in_channel</code> または <code class="language-plaintext highlighter-rouge">ephemeral</code> )、 <code class="language-plaintext highlighter-rouge">replace_original</code> 、 <code class="language-plaintext highlighter-rouge">delete_original</code> を含む JSON オブジェクトを渡すことができます。</p>
  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="c1">// "user_select" の action_id がトリガーされたアクションをリッスン</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="dl">'</span><span class="s1">user_select</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">action</span><span class="p">,</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">respond</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">users_select</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">respond</span><span class="p">(</span><span class="s2">`You selected &lt;@</span><span class="p">${</span><span class="nx">action</span><span class="p">.</span><span class="nx">selected_user</span><span class="p">}</span><span class="s2">&gt;`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="acknowledge">リクエストの確認</h3>

            <div class="section-content">
  <p>アクション（action）、コマンド（command）、およびオプション（options）リクエストは、<strong>必ず</strong> <code class="language-plaintext highlighter-rouge">ack()</code> 関数を用いて確認する必要があります。これにより Slack 側にリクエストが正常に受信されたことを知らせることができ、それに応じて Slack のユーザーインターフェイスが更新されます。リクエストのタイプによっては、確認の通知方法が異なる場合があります。たとえば、モーダルの送信を確認するとき、送信内容にエラーがあればバリデーションエラーとともに <code class="language-plaintext highlighter-rouge">ack()</code> を呼び出しますが、送信内容が問題なければ、そのようなパラメータなしで <code class="language-plaintext highlighter-rouge">ack()</code> を呼び出します。</p>

  <p>この <code class="language-plaintext highlighter-rouge">ack()</code> による応答は 3 秒以内に行う必要があります。新しいメッセージの送信や、データベースからの情報の取得などを行う前に、リクエストを受けてすぐに <code class="language-plaintext highlighter-rouge">ack()</code> を呼び出して応答を返してしまうことをおすすめします。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
<td class="rouge-code"><pre><span class="c1">// Regex でメールアドレスが有効かチェック</span>
<span class="kd">let</span> <span class="nx">isEmail</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">[\w\-\.]</span><span class="sr">+@</span><span class="se">([\w\-]</span><span class="sr">+</span><span class="se">\.)</span><span class="sr">+</span><span class="se">[\w\-]</span><span class="sr">+$/</span><span class="p">;</span>
<span class="c1">// 制約付きのオブジェクト を使用して ticket_submit という callback_id を持つモーダル送信をリッスン</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="dl">'</span><span class="s1">ticket_submit</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">view</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// block_id が `email_address` の input ブロックからメールアドレスを取得</span>
  <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="dl">'</span><span class="s1">email_address</span><span class="dl">'</span><span class="p">][</span><span class="dl">'</span><span class="s1">input_a</span><span class="dl">'</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>

  <span class="c1">// メールアドレスが有効。モーダルを受信</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">email</span> <span class="o">&amp;&amp;</span> <span class="nx">isEmail</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">email</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// メールアドレスが無効。エラーを確認</span>
    <span class="k">await</span> <span class="nx">ack</span><span class="p">({</span>
      <span class="dl">"</span><span class="s2">response_action</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">errors</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">errors</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">email_address</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Sorry, this isn’t a valid email</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="shortcuts">ショートカットのリスニング</h3>

            <div class="section-content">
  <p><code class="language-plaintext highlighter-rouge">shortcut()</code> メソッドは、<a href="https://api.slack.com/interactivity/shortcuts/using#global_shortcuts">グローバルショートカット</a>と<a href="https://api.slack.com/interactivity/shortcuts/using#message_shortcuts">メッセージショートカット</a>の両方をサポートします。</p>

  <p>ショートカットは、テキスト入力エリアや検索バーから起動できる Slack クライアント内の UI エレメントです。グローバルショートカットは、コンポーザーメニューまたは検索メニューから呼び出すことができます。メッセージショートカットは、メッセージのコンテキストメニュー内にあります。<code class="language-plaintext highlighter-rouge">shortcut()</code> メソッドを使って、これらのショートカットのリクエストをリッスンすることができます。このメソッドには <code class="language-plaintext highlighter-rouge">callback_id</code> を文字列または正規表現のデータ型で設定します。</p>

  <p>⚠️ 同じ対象にマッチする正規表現の <code class="language-plaintext highlighter-rouge">shortcut()</code> を複数使用する場合、マッチする <em>全ての</em> リスナーが実行されることに注意してください。そのような挙動を意図しない場合は、これが発生しないよう正規表現をデザインしてください。</p>

  <p>グローバルショートカットのリクエストは Slack へリクエストを受信したことを知らせるために <code class="language-plaintext highlighter-rouge">ack()</code> メソッドで確認する必要があります。</p>

  <p>グローバルショートカットのペイロードは、ユーザーの実行アクションの確認のために<a href="#creating-modals">モーダルを開く</a>などの用途に使用できる <code class="language-plaintext highlighter-rouge">trigger_id</code> を含んでいます。</p>

  <p>⚠️ グローバルショートカットのペイロードは <strong>チャンネル ID は含んでいない</strong> ことに注意してください。もしあなたのアプリがチャンネル ID を知る必要があれば、モーダル内で <a href="https://api.slack.com/reference/block-kit/block-elements#conversation_select"><code class="language-plaintext highlighter-rouge">conversations_select</code></a> エレメントを使用できます。
メッセージショートカットのペイロードはチャンネル ID を含みます。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td>
<td class="rouge-code"><pre><span class="c1">// open_modal というグローバルショートカットはシンプルなモーダルを開く</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">shortcut</span><span class="p">(</span><span class="dl">'</span><span class="s1">open_modal</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">shortcut</span><span class="p">,</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// グローバルショートカットリクエストの確認</span>
  <span class="nx">ack</span><span class="p">();</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// 組み込みの WebClient を使って views.open API メソッドを呼び出す</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">open</span><span class="p">({</span>
      <span class="c1">// `context` オブジェクトに保持されたトークンを使用</span>
      <span class="na">token</span><span class="p">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">botToken</span><span class="p">,</span>
      <span class="na">trigger_id</span><span class="p">:</span> <span class="nx">shortcut</span><span class="p">.</span><span class="nx">trigger_id</span><span class="p">,</span>
      <span class="na">view</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">modal</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">plain_text</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">My App</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="dl">"</span><span class="s2">close</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">plain_text</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Close</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="dl">"</span><span class="s2">blocks</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">section</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
              <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mrkdwn</span><span class="dl">"</span><span class="p">,</span>
              <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">About the simplest modal you could conceive of :smile:</span><span class="se">\n\n</span><span class="s2">Maybe &lt;https://api.slack.com/reference/block-kit/interactive-components|*make the modal interactive*&gt; or &lt;https://api.slack.com/surfaces/modals/using#modifying|*learn more advanced modal use cases*&gt;.</span><span class="dl">"</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">context</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">elements</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mrkdwn</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Psssst this modal was designed using &lt;https://api.slack.com/tools/block-kit-builder|*Block Kit Builder*&gt;</span><span class="dl">"</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">制約付きオブジェクトを使用したショートカットのリスニング</h4>
  </summary>

  <div class="secondary-content">
    <p>制約付きオブジェクトを使って <code class="language-plaintext highlighter-rouge">callback_id</code> や <code class="language-plaintext highlighter-rouge">type</code> によるリスニングができます。オブジェクト内の制約は文字列型または RegExp オブジェクトを使用できます。</p>

  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td>
<td class="rouge-code"><pre>  <span class="c1">// callback_id が 'open_modal' と一致し type が 'message_action' と一致する場合のみミドルウェアが呼び出される</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">shortcut</span><span class="p">({</span> <span class="na">callback_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">open_modal</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">message_action</span><span class="dl">'</span> <span class="p">},</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">shortcut</span><span class="p">,</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// ショートカットリクエストの確認</span>
      <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>

      <span class="c1">// 組み込みの WebClient を使って views.open API メソッドを呼び出す</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">open</span><span class="p">({</span>
        <span class="c1">// `context` オブジェクトに保持されたトークンを使用</span>
        <span class="na">token</span><span class="p">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">botToken</span><span class="p">,</span>
        <span class="na">trigger_id</span><span class="p">:</span> <span class="nx">shortcut</span><span class="p">.</span><span class="nx">trigger_id</span><span class="p">,</span>
        <span class="na">view</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">modal</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">title</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">plain_text</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="dl">"</span><span class="s2">My App</span><span class="dl">"</span>
          <span class="p">},</span>
          <span class="na">close</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">plain_text</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Close</span><span class="dl">"</span>
          <span class="p">},</span>
          <span class="na">blocks</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">section</span><span class="dl">"</span><span class="p">,</span>
              <span class="na">text</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mrkdwn</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">text</span><span class="p">:</span> <span class="dl">"</span><span class="s2">About the simplest modal you could conceive of :smile:</span><span class="se">\n\n</span><span class="s2">Maybe &lt;https://api.slack.com/reference/block-kit/interactive-components|*make the modal interactive*&gt; or &lt;https://api.slack.com/surfaces/modals/using#modifying|*learn more advanced modal use cases*&gt;.</span><span class="dl">"</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">context</span><span class="dl">"</span><span class="p">,</span>
              <span class="na">elements</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mrkdwn</span><span class="dl">"</span><span class="p">,</span>
                  <span class="na">text</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Psssst this modal was designed using &lt;https://api.slack.com/tools/block-kit-builder|*Block Kit Builder*&gt;</span><span class="dl">"</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="commands">コマンドのリスニングと応答</h3>

            <div class="section-content">
  <p>スラッシュコマンドが実行されたリクエストをリッスンするには、アプリで <code class="language-plaintext highlighter-rouge">command()</code> メソッドを使用します。メソッドの使用には文字列か正規表現の <code class="language-plaintext highlighter-rouge">commandName</code> の指定が必要です。</p>

  <p>⚠️ 同じ対象にマッチする正規表現の <code class="language-plaintext highlighter-rouge">command()</code> を複数使用する場合、マッチする <em>全ての</em> リスナーが実行されることに注意してください。そのような挙動を意図しない場合は、これが発生しないよう正規表現をデザインしてください。</p>

  <p>アプリがスラッシュコマンドのリクエストを受け取ったことを <code class="language-plaintext highlighter-rouge">ack()</code> の実行によって Slack に通知する必要があります。</p>

  <p>スラッシュコマンドへの応答には 2 つのやり方があります。1 つ目の方法は、文字列または JSON ペイロードを受け取る <code class="language-plaintext highlighter-rouge">say()</code> で、2 つ目は <code class="language-plaintext highlighter-rouge">response_url</code> を簡単に利用するためのユーティリティである <code class="language-plaintext highlighter-rouge">respond()</code> です。これらについては、「<a href="#action-respond">アクションへの応答</a>」セクションで詳しく説明しています。</p>

  <p>Slack アプリの管理画面でスラッシュコマンドを設定するとき、そのスラッシュコマンドの Request URL に（<code class="language-plaintext highlighter-rouge">https://{ドメイン}</code> に続いて） <code class="language-plaintext highlighter-rouge">/slack/events</code> を指定するようにしてください。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="c1">// この echo コマンドは ただ、その引数を（やまびこのように）おうむ返しする</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="dl">'</span><span class="s1">/echo</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">command</span><span class="p">,</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">respond</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// コマンドリクエストを確認</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>

  <span class="k">await</span> <span class="nx">respond</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">command</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="creating-modals">モーダルの開始</h3>

            <div class="section-content">

  <p><a href="https://api.slack.com/block-kit/surfaces/modals">モーダル</a>は、ユーザー情報を収集したり、動的な表示を実現するためのインターフェースです。モーダルは、有効な <code>trigger_id</code> と <a href="https://api.slack.com/reference/block-kit/views">ビュー部分のペイロード</a> を組み込みの API クライアントによる <a href="https://api.slack.com/methods/views.open"><code>views.open</code></a> メソッドの呼び出しに渡すことで開始することができます。</p>

  <p><code>trigger_id</code> はスラッシュコマンド、ボタンの押下、メニューの選択などによって Request URL に送信されたペイロードの項目として入手することができます。</p>

  <p>モーダルの生成についてのより詳細な情報は <a href="https://api.slack.com/surfaces/modals/using#composing_views">API ドキュメント</a>を参照してください。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td>
<td class="rouge-code"><pre><span class="c1">// コマンド起動をリッスン</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="dl">'</span><span class="s1">/ticket</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// コマンドのリクエストを確認</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">open</span><span class="p">({</span>
      <span class="c1">// 適切な trigger_id を受け取ってから 3 秒以内に渡す</span>
      <span class="na">trigger_id</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">trigger_id</span><span class="p">,</span>
      <span class="c1">// view の値をペイロードに含む</span>
      <span class="na">view</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">modal</span><span class="dl">'</span><span class="p">,</span>
        <span class="c1">// callback_id が view を特定するための識別子</span>
        <span class="na">callback_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">view_1</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Modal title</span><span class="dl">'</span>
        <span class="p">},</span>
        <span class="na">blocks</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">section</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mrkdwn</span><span class="dl">'</span><span class="p">,</span>
              <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Welcome to a modal with _blocks_</span><span class="dl">'</span>
            <span class="p">},</span>
            <span class="na">accessory</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">button</span><span class="dl">'</span><span class="p">,</span>
              <span class="na">text</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
                <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Click me!</span><span class="dl">'</span>
              <span class="p">},</span>
              <span class="na">action_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">button_abc</span><span class="dl">'</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">block_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">input_c</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">label</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
              <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">What are your hopes and dreams?</span><span class="dl">'</span>
            <span class="p">},</span>
            <span class="na">element</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text_input</span><span class="dl">'</span><span class="p">,</span>
              <span class="na">action_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dreamy_input</span><span class="dl">'</span><span class="p">,</span>
              <span class="na">multiline</span><span class="p">:</span> <span class="kc">true</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="na">submit</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Submit</span><span class="dl">'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="updating-pushing-views">モーダルの更新と多重表示</h3>

            <div class="section-content">
  <p>モーダルでは、複数のモーダルをスタックのように積み重ねて表示できます。<a href="https://api.slack.com/methods/views.open"><code class="language-plaintext highlighter-rouge">views.open</code></a> という API を呼び出すと、まず親の（最初の）モーダルが表示されます。この最初の呼び出しの後、<a href="https://api.slack.com/methods/views.update"><code class="language-plaintext highlighter-rouge">views.update</code></a> を実行することでそのビューを書き換えることもできますし、最初に述べたように <a href="https://api.slack.com/methods/views.push"><code class="language-plaintext highlighter-rouge">views.push</code></a> で新しいモーダルを積み重ねて表示することもできます。</p>

  <p><strong><code>views.update</code></strong><br>
モーダルの更新には、組み込みの API クライアントを使って <code>views.update</code> を呼び出します。この API 呼び出しには、そのモーダルを開いたときに生成された <code>view_id</code> と、更新後の内容を表現する <code>blocks</code> の配列を含む新しい <code>view</code> を渡します。ユーザーが既存のモーダル内の要素とインタラクションを行なった（例：ボタンを押す、メニューから選択する）ことをトリガーにビューを更新する場合、そのリクエストの <code>body</code> に <code>view_id</code> が含まれます。</p>

  <p><strong><code>views.push</code></strong><br>
モーダルのスタックに新しいモーダルを積み重ねるためには、組み込みの API クライアントを用いて <code>views.push</code> を呼び出します。この API 呼び出しには、有効な <code>trigger_id</code> と、新しく生成する <a href="https://api.slack.com/reference/block-kit/views">ビュー部分のペイロード</a>を渡します。<code class="language-plaintext highlighter-rouge">views.push</code> の引数は <a href="#creating-modals">モーダルを開始するとき</a>と同様です。最初のモーダルを開いた後、その上にさらに二つまで追加のモーダルをスタックに積み重ねることができます。</p>

  <p>より詳細な情報は <a href="https://slack.dev/bolt/concepts#view_submissions">API ドキュメント</a>を参照してください。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td>
<td class="rouge-code"><pre><span class="c1">// action_id: button_abc のボタンを押すイベントをリッスン</span>
<span class="c1">// （そのボタンはモーダルの中にあるという想定）</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">action</span><span class="p">(</span><span class="dl">'</span><span class="s1">button_abc</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ボタンを押したイベントを確認</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">block_actions</span><span class="dl">'</span> <span class="o">||</span> <span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
      <span class="c1">// リクエストに含まれる view_id を渡す</span>
      <span class="na">view_id</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="c1">// 競合状態を防ぐために更新前の view に含まれる hash を指定</span>
      <span class="na">hash</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">hash</span><span class="p">,</span>
      <span class="c1">// 更新された view の値をペイロードに含む</span>
      <span class="na">view</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">modal</span><span class="dl">'</span><span class="p">,</span>
        <span class="c1">// callback_id が view を特定するための識別子</span>
        <span class="na">callback_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">view_1</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Updated modal</span><span class="dl">'</span>
        <span class="p">},</span>
        <span class="na">blocks</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">section</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
              <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">You updated the modal!</span><span class="dl">'</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">image</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">image_url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://media.giphy.com/media/SVZGEcYt7brkFUyU90/giphy.gif</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">alt_text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Yay! The modal was updated</span><span class="dl">'</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="view-submissions">モーダルでの送信のリスニング</h3>

            <div class="section-content">

  <p><code class="language-plaintext highlighter-rouge">view</code> メソッドを使うと、ユーザーのビューとのインタラクションをリッスンすることができます。</p>

  <p>ユーザーがモーダルからデータ送信したとき、Slack から <code class="language-plaintext highlighter-rouge">view_submission</code> のリクエストが送信されます。送信された <code class="language-plaintext highlighter-rouge">input</code> ブロックの値は <code class="language-plaintext highlighter-rouge">state</code> オブジェクトから取得できます。<code class="language-plaintext highlighter-rouge">state</code> 内には <code class="language-plaintext highlighter-rouge">values</code> というオブジェクトがあり、これは <code class="language-plaintext highlighter-rouge">block_id</code> と一意な <code class="language-plaintext highlighter-rouge">action_id</code> に紐づける形で入力値を保持しています。
モーダルでの <code class="language-plaintext highlighter-rouge">notify_on_close</code> プロパティを <code class="language-plaintext highlighter-rouge">true</code> に設定した場合、ユーザーが Close ボタンを押したときに Slack から <code class="language-plaintext highlighter-rouge">view_closed</code> リクエストが送信されます。 より詳細な情報は以下の <strong>モーダルを閉じるときのハンドリング</strong> を参照してください。
<code class="language-plaintext highlighter-rouge">view_submission</code> や <code class="language-plaintext highlighter-rouge">view_closed</code> リクエストをリッスンするには、組み込みの <code class="language-plaintext highlighter-rouge">view()</code> メソッドを使用できます。</p>

  <p><code class="language-plaintext highlighter-rouge">view()</code> メソッドでは、文字列か正規表現の <code class="language-plaintext highlighter-rouge">callback_id</code> の指定が必要です。<code class="language-plaintext highlighter-rouge">type</code> と <code class="language-plaintext highlighter-rouge">callback_id</code> を含む制約付きオブジェクトを渡すこともできます。</p>

  <hr>

  <h5 id="section">モーダル送信でのビューの更新</h5>

  <p><code class="language-plaintext highlighter-rouge">view_submission</code> リクエストに対してモーダルを更新するには、リクエストの確認の中で <code class="language-plaintext highlighter-rouge">update</code> という <code class="language-plaintext highlighter-rouge">response_action</code> と新しく作成した <code class="language-plaintext highlighter-rouge">view</code> を指定します。</p>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="c1">// モーダル送信でのビューの更新</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="dl">'</span><span class="s1">modal-callback-id</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">body</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">({</span>
    <span class="na">response_action</span><span class="p">:</span> <span class="dl">'</span><span class="s1">update</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">view</span><span class="p">:</span> <span class="nx">buildNewModalView</span><span class="p">(</span><span class="nx">body</span><span class="p">),</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>
  <p>この例と同様に、モーダルでの送信リクエストに対して、<a href="https://api.slack.com/surfaces/modals/using#displaying_errors">エラーを表示する</a> ためのオプションもあります。</p>

  <p>より詳細な情報は <a href="https://api.slack.com/surfaces/modals/using#handling_submissions">API ドキュメント</a>を参照してください。</p>

  <hr>

  <h5 id="section-1">モーダルを閉じるときのハンドリング</h5>

  <p>💡 <code class="language-plaintext highlighter-rouge">view_closed</code> リクエストをリッスンするとき、<code class="language-plaintext highlighter-rouge">callback_id</code> と <code class="language-plaintext highlighter-rouge">type: 'view_closed'</code> を含むオブジェクトの指定が必要です。以下の例を参照してください。</p>

  <p><code class="language-plaintext highlighter-rouge">view_closed</code> に関するより詳細な情報は <a href="https://api.slack.com/surfaces/modals/using#modal_cancellations">API ドキュメント</a>を参照してください。</p>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="c1">// view_closed リクエストの処理</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span> <span class="na">callback_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">view_b</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">view_closed</span><span class="dl">'</span> <span class="p">},</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">client</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// view_closed リクエストの確認</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>
  <span class="c1">// close リクエストについて何らかの処理</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td>
<td class="rouge-code"><pre><span class="c1">// モーダルでのデータ送信リクエストを処理します</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="dl">'</span><span class="s1">view_b</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// モーダルでのデータ送信リクエストを確認</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>

  <span class="c1">// 入力値を使ってやりたいことをここで実装 - ここでは DB に保存して送信内容の確認を送っている</span>

  <span class="c1">// block_id: block_1 という input ブロック内で action_id: input_a の場合の入力</span>
  <span class="kd">const</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">view</span><span class="p">[</span><span class="dl">'</span><span class="s1">state</span><span class="dl">'</span><span class="p">][</span><span class="dl">'</span><span class="s1">values</span><span class="dl">'</span><span class="p">][</span><span class="dl">'</span><span class="s1">block_1</span><span class="dl">'</span><span class="p">][</span><span class="dl">'</span><span class="s1">input_a</span><span class="dl">'</span><span class="p">];</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">body</span><span class="p">[</span><span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">][</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">];</span>

  <span class="c1">// ユーザーに対して送信するメッセージ</span>
  <span class="kd">let</span> <span class="nx">msg</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
  <span class="c1">// DB に保存</span>
  <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// DB への保存が成功</span>
    <span class="nx">msg</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Your submission was successful</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">msg</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">There was an error with your submission</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// ユーザーにメッセージを送信</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
      <span class="na">channel</span><span class="p">:</span> <span class="nx">user</span><span class="p">,</span>
      <span class="na">text</span><span class="p">:</span> <span class="nx">msg</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="publishing-views">ホームタブの更新</h3>

            <div class="section-content">
  <p><a href="https://api.slack.com/surfaces/tabs/using">ホームタブ</a>は、サイドバーや検索画面からアクセス可能なサーフェスエリアです。アプリはこのエリアを使ってユーザーごとのビューを表示することができます。アプリ設定ページで App Home の機能を有効にすると、<a href="https://api.slack.com/methods/views.publish"><code class="language-plaintext highlighter-rouge">views.publish</code></a> API メソッドの呼び出しで <code class="language-plaintext highlighter-rouge">user_id</code> と<a href="https://api.slack.com/reference/block-kit/views">ビューのペイロード</a>を指定して、ホームタブを公開・更新することができるようになります。</p>

  <p>エンドユーザーが App Home（ホームタブやアプリとの DM など）にアクセスしたことを知るために、<a href="https://api.slack.com/events/app_home_opened"><code class="language-plaintext highlighter-rouge">app_home_opened</code></a> イベントをサブスクライブすることができます。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td>
<td class="rouge-code"><pre><span class="c1">// ユーザーが App Home にアクセスしたことを伝えるイベントをリッスン</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="dl">'</span><span class="s1">app_home_opened</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// 組み込みの API クライアントを使って views.publish を呼び出す</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">publish</span><span class="p">({</span>
      <span class="c1">// イベントに紐づけられたユーザー ID を指定</span>
      <span class="na">user_id</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span>
      <span class="na">view</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// ホームタブはあらかじめアプリ設定ページで有効にしておく必要があります</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">home</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">blocks</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">section</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mrkdwn</span><span class="dl">"</span><span class="p">,</span>
              <span class="na">text</span><span class="p">:</span> <span class="dl">"</span><span class="s2">*Welcome home, &lt;@</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&gt; :house:*</span><span class="dl">"</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">section</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mrkdwn</span><span class="dl">"</span><span class="p">,</span>
              <span class="na">text</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Learn how home tabs can be more useful and interactive &lt;https://api.slack.com/surfaces/tabs/using|*in the documentation*&gt;.</span><span class="dl">"</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="options">オプションのリスニングと応答</h3>

            <div class="section-content">
  <p><code class="language-plaintext highlighter-rouge">options()</code> メソッドは、Slack からのオプション（セレクトメニュー内の動的な選択肢）をリクエストするペイロードをリッスンします。 <a href="#action-listening"><code class="language-plaintext highlighter-rouge">action()</code> と同様</a>に、文字列型の <code class="language-plaintext highlighter-rouge">action_id</code> または制約付きオブジェクトが必要です。</p>

  <p><code class="language-plaintext highlighter-rouge">external_select</code> メニューには <code class="language-plaintext highlighter-rouge">action_id</code> を使用することをおすすめしますが、ダイアログはまだ Block Kit をサポートしていないため、制約オブジェクトを用いて <code class="language-plaintext highlighter-rouge">callback_id</code> でフィルタリングする必要があります。</p>

  <p>オプションのリクエストへの応答には、適切なオプションを指定して <code class="language-plaintext highlighter-rouge">ack()</code> を実行する必要があります。API サイトに掲載されている<a href="https://api.slack.com/reference/messaging/block-elements#external-select">external_select の応答の例</a>や<a href="https://api.slack.com/dialogs#dynamic_select_elements_external">ダイアログ応答の例</a>を参考にしてください。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td>
<td class="rouge-code"><pre><span class="c1">// external_select オプションリクエストに応答する例</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">(</span><span class="dl">'</span><span class="s1">external_action</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ack</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// チームまたはチャンネル情報を取得</span>
  <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">team</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="c1">// ack 応答 するために options 配列に情報をプッシュ</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">result</span> <span class="k">of</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="na">text</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">plain_text</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">text</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">label</span>
        <span class="p">},</span>
        <span class="na">value</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">ack</span><span class="p">({</span>
      <span class="na">options</span><span class="p">:</span> <span class="nx">options</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="authenticating-oauth">OAuth フローの実装</h3>

            <div class="section-content">
  <p>Slack アプリの配布を行うには Bolt による OAuth フローを実装し、インストール時に取得した情報をセキュアな方法で保存しておく必要があります。
Bolt は OAuth フローそのものに加えて OAuth のためのルーティング、 state パラメーターの検証、保存するためのインストール情報をアプリに受け渡す、などの処理をハンドリングします。</p>

  <p>OAuth を有効にするために、以下を提供する必要があります：</p>
  <ul>
    <li>
<code class="language-plaintext highlighter-rouge">clientId</code>, <code class="language-plaintext highlighter-rouge">clientSecret</code>, <code class="language-plaintext highlighter-rouge">stateSecret</code>, <code class="language-plaintext highlighter-rouge">scopes</code> <em>(必須)</em>
</li>
    <li>
<code class="language-plaintext highlighter-rouge">installationStore</code> オプションは、インストール情報の保存と取得を行うハンドラーを提供します <em>(必須とはなっていませんが、本番環境では設定することを強く推奨します)</em>
</li>
  </ul>

  <h5 id="section">開発とテスト</h5>

  <p>開発・テストの際に利用することを想定して <code class="language-plaintext highlighter-rouge">installationStore</code> オプションのデフォルト実装である <code class="language-plaintext highlighter-rouge">FileInstallationStore</code> を提供しています。</p>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">FileInstallationStore</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/oauth</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
  <span class="na">clientId</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_ID</span><span class="p">,</span>
  <span class="na">clientSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_SECRET</span><span class="p">,</span>
  <span class="na">stateSecret</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-state-secret</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">scopes</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">channels:history</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">chat:write</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">commands</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">installationStore</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FileInstallationStore</span><span class="p">(),</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>
  <p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> 本番運用での利用は <strong>推奨しません</strong> ので、本番向けのデータストアはご自身で実装する必要があります。サンプルコードとして <a href="https://github.com/slackapi/bolt-js/tree/main/examples/oauth">OAuth の他の実装例</a>を参照してください。</p>

  <h5 id="section-1">アプリのインストール</h5>

  <ul>
    <li>
<strong>インストールの開始</strong>: Bolt for JavaScript は <code class="language-plaintext highlighter-rouge">/slack/install</code> という <strong>インストール用のパス</strong> を生成します。これは、有効な <code class="language-plaintext highlighter-rouge">state</code> パラメータを生成した上で Slack アプリの直接のインストールを開始するための <code class="language-plaintext highlighter-rouge">Add to Slack</code> ボタンを含むページを応答する URL です。 <em>www.example.com</em> でホスティングされているアプリの場合、インストールページは <em>www.example.com/slack/install</em> となります。
      <ul>
        <li>💡 <code class="language-plaintext highlighter-rouge">App</code> コンストラクタ内で <code class="language-plaintext highlighter-rouge">installerOptions.directInstall: true</code> を設定すると、デフォルトのウェブページを描画する代わりに、ユーザーを直接 Slack の authorize URL に誘導することができます（<a href="https://github.com/slackapi/bolt-js/blob/5b4d9ceb65e6bf5cf29dfa58268ea248e5466bfb/examples/oauth/app.js#L58-L64">例</a>）。</li>
      </ul>
    </li>
    <li>
      <p><strong>Add to Slack (Slack へ追加)</strong>: <code class="language-plaintext highlighter-rouge">Add to Slack</code> ボタンを押すと Slack との OAuth プロセスを開始します。ユーザーがアプリへの権限付与を許可すると、Slack はアプリの <strong>Redirect URI</strong> （あらかじめ設定されています）へユーザーを誘導し、処理が正常に完了したらユーザーに <strong>Slack で開く</strong> よう促します。これらの設定をカスタマイズする方法については、後述の <strong>Redirect URI</strong> セクションを参照してください。</p>
    </li>
    <li>
      <p><strong>Slack で開く</strong>: ユーザーが <strong>Slack で開く</strong> を選択した後、アプリが Slack からのイベントをするときに <code class="language-plaintext highlighter-rouge">installationStore</code> の <code class="language-plaintext highlighter-rouge">fetchInstallation</code> や <code class="language-plaintext highlighter-rouge">storeInstallation</code> ハンドラーが実行されます。ハンドラーに渡す引数に関するより詳しい情報は  <strong>Installation Object</strong> セクションを参照してください。</p>
    </li>
    <li>
      <p>アプリがすでにインストールされていて、さらにユーザーから追加の認可情報（例：ユーザートークンの発行）な場合や、何らかの理由で動的にインストール用の URL を生成したい場合は、<code class="language-plaintext highlighter-rouge">ExpressReceiver</code> を自前でインスタンス化し、それを <code class="language-plaintext highlighter-rouge">receiver</code> という変数に代入した上で <code class="language-plaintext highlighter-rouge">receiver.installer.generateInstallUrl()</code> を呼び出してください。詳しくは <a href="https://slack.dev/node-slack-sdk/oauth#generating-an-installation-url">OAuth ライブラリのドキュメント</a>の <code class="language-plaintext highlighter-rouge">generateInstallUrl()</code> を参照してください。</p>
    </li>
    <li>💡 Bolt for JavaScript は <a href="#receiver">カスタムのレシーバー</a>での OAuth をサポートしていません。カスタムのレシーバーで OAuth フローを実装したい場合は、私たちが提供している <a href="https://slack.dev/node-slack-sdk/oauth#slack-oauth">OAuth ライブラリ</a> を使うことができます。Bolt for JavaScript の組み込みのモジュールもこれを内部的に利用しています。</li>
  </ul>

  <h5 id="redirect-uri">Redirect URI</h5>

  <p>Bolt for JavaScript は、アプリのインストールフローを完了した後の遷移先の URL である <strong>Redirect URI</strong> のためのパスとして <code class="language-plaintext highlighter-rouge">/slack/oauth_redirect</code> を有効にします。</p>

  <p>💡 アプリのドメインを含んだ <strong>Redirect URI</strong> （絶対 URI）を Slack アプリの設定画面の <strong>OAuth and Permissions</strong> セクション内で設定してください。（例 <code class="language-plaintext highlighter-rouge">https://example.com/slack/oauth_redirect</code> ）。</p>

  <p>カスタムの <strong>Redirect URI</strong> を使う場合、 App クラスの引数 <code class="language-plaintext highlighter-rouge">redirectUri</code> と <code class="language-plaintext highlighter-rouge">installerOptions.redirectUriPath</code> にも設定してください。 両方とも設定する必要があり、また、矛盾のないフル URI である必要があります。</p>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
  <span class="na">clientId</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_ID</span><span class="p">,</span>
  <span class="na">clientSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_SECRET</span><span class="p">,</span>
  <span class="na">stateSecret</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-state-secret</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">scopes</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">chat:write</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">redirectUri</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://example.com/slack/redirect</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// ここに設定します</span>
  <span class="na">installerOptions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">redirectUriPath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/slack/redirect</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// ここにも！</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

  <h5 id="installation-">Installation オブジェクト</h5>

  <p>Bolt は <code class="language-plaintext highlighter-rouge">installationStore</code> の <code class="language-plaintext highlighter-rouge">storeInstallation</code> ハンドラーに <code class="language-plaintext highlighter-rouge">installation</code> オブジェクトを渡します。どのようなオブジェクトの形式となるか想像しづらいと開発時に混乱の元になるかもしれません。<code class="language-plaintext highlighter-rouge">installation</code> オブジェクトはこのような形式となります：</p>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
<td class="rouge-code"><pre><span class="p">{</span>
  <span class="nl">team</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">T012345678</span><span class="dl">'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">example-team-name</span><span class="dl">'</span> <span class="p">},</span>
  <span class="nx">enterprise</span><span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
  <span class="nx">user</span><span class="p">:</span> <span class="p">{</span> <span class="nl">token</span><span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">scopes</span><span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">U01234567</span><span class="dl">'</span> <span class="p">},</span>
  <span class="nx">tokenType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bot</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">isEnterpriseInstall</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">appId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">A01234567</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">authVersion</span><span class="p">:</span> <span class="dl">'</span><span class="s1">v2</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">bot</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">scopes</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">'</span><span class="s1">chat:write</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="nx">token</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xoxb-244493-28*********-********************</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">userId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">U012345678</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">B01234567</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

  <p>Bolt は <code class="language-plaintext highlighter-rouge">fetchInstallation</code> と <code class="language-plaintext highlighter-rouge">deleteInstallation</code> ハンドラーに <code class="language-plaintext highlighter-rouge">installQuery</code> オブジェクトを渡します：</p>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="p">{</span>
  <span class="nl">userId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">U012345678</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">isEnterpriseInstall</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">teamId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">T012345678</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">enterpriseId</span><span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
  <span class="nx">conversationId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">D02345678</span><span class="dl">'</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

  <h5 id="org-">OrG 全体へのインストール</h5>

  <p><a href="https://api.slack.com/enterprise/apps">Enterprise Grid の OrG 全体へのインストール</a>への対応を追加する場合、Bolt for JavaScript のバージョン 3.0.0 以上を利用してください。また Slack アプリの設定画面で <strong>Org Level Apps</strong> の設定が有効になっていることを確認してください。</p>

  <p>管理者画面からの <a href="https://api.slack.com/enterprise/apps">Enterprise Grid の OrG 全体へのインストール</a> の場合、 Bolt で動作させるために追加の設定が必要です。この利用シナリオでは、推奨の <code class="language-plaintext highlighter-rouge">state</code> パラメータが提供されず、Bolt アプリでは <code class="language-plaintext highlighter-rouge">state</code> を検証しようとするため、インストールを継続することができません。</p>

  <p>Bolt アプリ側で <code class="language-plaintext highlighter-rouge">stateVerification</code> オプションを false に設定することで、 <code class="language-plaintext highlighter-rouge">state</code> パラメーターの検証を無効することができます。以下の例を参考にしてください。</p>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
  <span class="na">clientId</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_ID</span><span class="p">,</span>
  <span class="na">clientSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_SECRET</span><span class="p">,</span>
  <span class="na">scopes</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">chat:write</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">installerOptions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">stateVerification</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

  <p>Slack の OAuth インストールフローについてのより詳細な情報は <a href="https://api.slack.com/authentication/oauth-v2">API ドキュメント</a>を参照してください。</p>

</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
  <span class="na">clientId</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_ID</span><span class="p">,</span>
  <span class="na">clientSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_SECRET</span><span class="p">,</span>
  <span class="na">stateSecret</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-state-secret</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">scopes</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">channels:read</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">groups:read</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">channels:manage</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">chat:write</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">incoming-webhook</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">installationStore</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">storeInstallation</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">installation</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// 実際のデータベースに保存するために、ここのコードを変更</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">installation</span><span class="p">.</span><span class="nx">isEnterpriseInstall</span> <span class="o">&amp;&amp;</span> <span class="nx">installation</span><span class="p">.</span><span class="nx">enterprise</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// OrG 全体へのインストールに対応する場合</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nx">database</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">installation</span><span class="p">.</span><span class="nx">enterprise</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">installation</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">installation</span><span class="p">.</span><span class="nx">team</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 単独のワークスペースへのインストールの場合</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nx">database</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">installation</span><span class="p">.</span><span class="nx">team</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">installation</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Failed saving installation data to installationStore</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">fetchInstallation</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">installQuery</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// 実際のデータベースから取得するために、ここのコードを変更</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">installQuery</span><span class="p">.</span><span class="nx">isEnterpriseInstall</span> <span class="o">&amp;&amp;</span> <span class="nx">installQuery</span><span class="p">.</span><span class="nx">enterpriseId</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// OrG 全体へのインストール情報の参照</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nx">database</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">installQuery</span><span class="p">.</span><span class="nx">enterpriseId</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">installQuery</span><span class="p">.</span><span class="nx">teamId</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 単独のワークスペースへのインストール情報の参照</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nx">database</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">installQuery</span><span class="p">.</span><span class="nx">teamId</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Failed fetching installation</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">deleteInstallation</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">installQuery</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// 実際のデータベースから削除するために、ここのコードを変更</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">installQuery</span><span class="p">.</span><span class="nx">isEnterpriseInstall</span> <span class="o">&amp;&amp;</span> <span class="nx">installQuery</span><span class="p">.</span><span class="nx">enterpriseId</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// OrG 全体へのインストール情報の削除</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nx">myDB</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">installQuery</span><span class="p">.</span><span class="nx">enterpriseId</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">installQuery</span><span class="p">.</span><span class="nx">teamId</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 単独のワークスペースへのインストール情報の削除</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nx">myDB</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">installQuery</span><span class="p">.</span><span class="nx">teamId</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Failed to delete installation</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">OAuth デフォルト設定をカスタマイズ</h4>
  </summary>

  <div class="secondary-content">

    <p><code class="language-plaintext highlighter-rouge">installerOptions</code> を使って OAuth モジュールのデフォルト設定を上書きすることができます。このカスタマイズされた設定は <code class="language-plaintext highlighter-rouge">App</code> の初期化時に渡します。以下の情報を変更可能です:</p>

    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">authVersion</code>: 新しい Slack アプリとクラシック Slack アプリの切り替えに使用</li>
      <li>
<code class="language-plaintext highlighter-rouge">metadata</code>: セッションに関連する情報の指定に使用</li>
      <li>
<code class="language-plaintext highlighter-rouge">installPath</code>: “Add to Slack” ボタンのためのパスを変更するために使用</li>
      <li>
<code class="language-plaintext highlighter-rouge">redirectUriPath</code>: Redirect URL を変更するために使用</li>
      <li>
<code class="language-plaintext highlighter-rouge">callbackOptions</code>: OAuth フロー完了時の成功・エラー完了画面をカスタマイズするために使用</li>
      <li>
<code class="language-plaintext highlighter-rouge">stateStore</code>: 組み込みの <code class="language-plaintext highlighter-rouge">ClearStateStore</code> の代わりにカスタムのデータストアを有効にするために使用</li>
      <li>
<code class="language-plaintext highlighter-rouge">userScopes</code>: 親の階層にある <code class="language-plaintext highlighter-rouge">scopes</code> プロパティと同様、ユーザがアプリをインストールする際に必要となるユーザスコープのリストの指定に使用</li>
    </ul>

  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">database</span> <span class="o">=</span> <span class="p">{</span>
  <span class="k">async</span> <span class="kd">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{},</span>
  <span class="k">async</span> <span class="k">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{},</span>
  <span class="k">async</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
  <span class="na">clientId</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_ID</span><span class="p">,</span>
  <span class="na">clientSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_SECRET</span><span class="p">,</span>
  <span class="na">scopes</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">channels:read</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">groups:read</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">channels:manage</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">chat:write</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">incoming-webhook</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">installerOptions</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">authVersion</span><span class="p">:</span> <span class="dl">'</span><span class="s1">v1</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// デフォルトは 'v2' (クラシック Slack アプリは 'v1')</span>
      <span class="na">metadata</span><span class="p">:</span> <span class="dl">'</span><span class="s1">some session data</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">installPath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/slack/installApp</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">redirectUriPath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/slack/redirect</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">userScopes</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">chat:write</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">callbackOptions</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">success</span><span class="p">:</span> <span class="p">(</span><span class="nx">installation</span><span class="p">,</span> <span class="nx">installOptions</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="c1">// ここで成功時のカスタムロジックを実装</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">successful!</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">},</span> 
        <span class="na">failure</span><span class="p">:</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">installOptions</span> <span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="c1">// ここでエラー時のカスタムロジックを実装</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">failure</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="na">stateStore</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// `stateStore` を指定する場合は `stateSecret` の設定が不要</span>

        <span class="c1">// 第一引数は `generateInstallUrl` メソッドに渡される `InstallUrlOptions` オブジェクト、第二引数は日付オブジェクト</span>
        <span class="c1">// state の文字列を応答</span>
        <span class="na">generateStateParam</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">installUrlOptions</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="c1">// URL の state パラメーターとして使用するランダムな文字列を生成</span>
          <span class="kd">const</span> <span class="nx">randomState</span> <span class="o">=</span> <span class="nx">randomStringGenerator</span><span class="p">();</span>
          <span class="c1">// その値をキャッシュ、データベースに保存</span>
          <span class="k">await</span> <span class="nx">myDB</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">randomState</span><span class="p">,</span> <span class="nx">installUrlOptions</span><span class="p">);</span>
          <span class="c1">// データベースに保存されたものを利用可能な値として返却</span>
          <span class="k">return</span> <span class="nx">randomState</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="c1">// 第一引数は日付オブジェクトで、第二引数は state を表現する文字列</span>
        <span class="c1">// `installUrlOptions` オブジェクトを応答</span>
        <span class="na">verifyStateParam</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="c1">// state をキーに、データベースから保存された installOptions を取得</span>
          <span class="kd">const</span> <span class="nx">installUrlOptions</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">myDB</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">randomState</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">installUrlOptions</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="socket-mode">ソケットモードの使用</h3>

            <div class="section-content">

  <p><a href="https://api.slack.com/socket-mode">ソケットモード</a> は、アプリに WebSocket での接続と、そのコネクション経由でのデータ受信を可能とします。コネクションをハンドリングするために <code class="language-plaintext highlighter-rouge">@slack/bolt@3.0.0</code> 以上では <code class="language-plaintext highlighter-rouge">SokcetModeReceiver</code> というレシーバーが提供されています。ソケットモードを使う前に、アプリの管理画面でソケットモードの機能が有効になっていることを確認しておいてください。</p>

  <p><code class="language-plaintext highlighter-rouge">SocketModeReceiver</code> を使う方法は <code class="language-plaintext highlighter-rouge">App</code> インスタンスの初期化時にコンストラクターに <code class="language-plaintext highlighter-rouge">socketMode: true</code> と <code class="language-plaintext highlighter-rouge">appToken: YOUR_APP_TOKEN</code> を渡すだけです。App Level Token は、アプリ管理画面の <strong>Basic Information</strong> セクションから取得できます。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BOT_TOKEN</span><span class="p">,</span>
  <span class="na">socketMode</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">appToken</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_TOKEN</span><span class="p">,</span>
<span class="p">});</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">⚡️ Bolt app started</span><span class="dl">'</span><span class="p">);</span>
<span class="p">})();</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">ソケットモードレシーバーのカスタム初期化</h4>
  </summary>

  <div class="secondary-content">

    <p>以下のように <code class="language-plaintext highlighter-rouge">@slack/bolt</code> から <code class="language-plaintext highlighter-rouge">SocketModeReceiver</code> を import して、カスタムされたインスタンスとして定義することができます。</p>

  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">SocketModeReceiver</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">socketModeReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SocketModeReceiver</span><span class="p">({</span>
  <span class="na">appToken</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_TOKEN</span><span class="p">,</span>

  <span class="c1">// OAuth フローの実装を合わせて使う場合は、以下を有効にしてください</span>
  <span class="c1">// clientId: process.env.CLIENT_ID,</span>
  <span class="c1">// clientSecret: process.env.CLIENT_SECRET,</span>
  <span class="c1">// stateSecret: 'my-state-secret',</span>
  <span class="c1">// scopes: ['channels:read', 'chat:write', 'app_mentions:read', 'channels:manage', 'commands'],</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">receiver</span><span class="p">:</span> <span class="nx">socketModeReceiver</span><span class="p">,</span>
  <span class="c1">// OAuth を使うなら以下の token 指定は不要です</span>
  <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BOT_TOKEN</span>
<span class="p">});</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">⚡️ Bolt app started</span><span class="dl">'</span><span class="p">);</span>
<span class="p">})();</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
        </div>

        <div id="advanced">
           
          <div class="section-wrapper">
            <h3 id="error-handling">エラーの処理</h3>

            <div class="section-content">
  <p><em>注: Bolt 2.x からエラーハンドリングが改善されました！この変更については <a href="https://slack.dev/bolt/ja-jp/tutorial/migration-v2">2.x マイグレーションガイド</a>を参照してください。</em></p>

  <p>リスナーでエラーが発生した場合は <code class="language-plaintext highlighter-rouge">try</code>/<code class="language-plaintext highlighter-rouge">catch</code> を使って直接ハンドリングすることをおすすめします。しかし、それでもなおすり抜けてしまうエラーのパターンもあるでしょう。デフォルトでは、このようなエラーはコンソールにログ出力されます。ご自身でこれらをハンドリングするには、<code class="language-plaintext highlighter-rouge">app.error(fn)</code> メソッドによって、グローバルエラーハンドラーを定義してください。</p>
</div>

<p>また、様々なエラーパターンにより特化したエラーハンドラーを <code class="language-plaintext highlighter-rouge">HTTPReceiver</code> に直接設定することができます。</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">dispatchErrorHandler</code>: 想定しないパスにリクエストが来たときに実行されます</li>
  <li>
<code class="language-plaintext highlighter-rouge">processEventErrorHandler</code>: リクエストを処理するとき（例：ミドルウェアや認可プロセス）に発生した例外に対して実行されます</li>
  <li>
<code class="language-plaintext highlighter-rouge">unhandledRequestHandler</code>: Slack からのリクエストが確認（<code class="language-plaintext highlighter-rouge">ack()</code>）されなかったときに実行されます</li>
  <li>
<code class="language-plaintext highlighter-rouge">unhandledRequestTimeoutMillis</code>: リクエストが受信されてから <code class="language-plaintext highlighter-rouge">unhandledRequestHandler</code> が実行されるまでの待機時間（ミリ秒単位）。 デフォルトは <code class="language-plaintext highlighter-rouge">3001</code> です。</li>
</ul>

<p><em>注</em>: あなたのアプリ内に定義されたカスタムのエラーハンドラーは、エラーとなった Slack からのリクストに応答するために <code class="language-plaintext highlighter-rouge">response.writeHead()</code> を呼び出して応答の HTTP ステータスコードを設定し、かつ <code class="language-plaintext highlighter-rouge">response.end()</code> を呼び出して Slack へのレスポンスを送信する必要があります。詳細は以下の例を参考にしてください。
&lt;/div&gt;</p>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td>
<td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">HTTPReceiver</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">receiver</span><span class="p">:</span> <span class="k">new</span> <span class="nx">HTTPReceiver</span><span class="p">({</span>
    <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
    <span class="c1">// より特定のパターンに特化したエラーハンドラー</span>
    <span class="na">dispatchErrorHandler</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">response</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`dispatch error: </span><span class="p">${</span><span class="nx">error</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">"</span><span class="s2">Something is wrong!</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="na">processEventErrorHandler</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">response</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`processEvent error: </span><span class="p">${</span><span class="nx">error</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="c1">// とにかく ack する</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="na">unhandledRequestHandler</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">response</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">'</span><span class="s1">Acknowledging this incoming request because 2 seconds already passed...</span><span class="dl">'</span><span class="p">);</span>
      <span class="c1">// とにかく ack する</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="na">unhandledRequestTimeoutMillis</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="c1">// デフォルトは 3001</span>
  <span class="p">}),</span>
<span class="p">});</span>

<span class="c1">// より一般的なグローバルのエラーハンドラー</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// メッセージ送信をリトライすべきか、アプリを停止すべきか判断するためにエラーの詳細を確認</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">エラーハンドラーでのさらなるデータの参照</h4>
  </summary>

  <div class="secondary-content">
    <p>グローバルエラーハンドラーの中で、リクエストからのデータをログ出力したい場合もあるでしょう。あるいは単に Bolt に設定した <code class="language-plaintext highlighter-rouge">logger</code> を利用したい場合もあるでしょう。</p>

    <p>バージョン 3.8.0 からは、コンストラクターに  <code class="language-plaintext highlighter-rouge">extendedErrorHandler: true</code> を渡すと、エラーハンドラーはリクエストの <code class="language-plaintext highlighter-rouge">error</code> 、 <code class="language-plaintext highlighter-rouge">logger</code> 、 <code class="language-plaintext highlighter-rouge">context</code> 、 <code class="language-plaintext highlighter-rouge">body</code> を含むオブジェクトを受け取ります。</p>

    <p><code class="language-plaintext highlighter-rouge">context</code> や <code class="language-plaintext highlighter-rouge">body</code> オブジェクト内にアクセスしたいプロパティが存在するかどうかをチェックすることをおすすめします。なぜなら <code class="language-plaintext highlighter-rouge">body</code> オブジェクト内に存在するデータはイベント毎に異なりますし、エラーはリクエストのライフサイクルの中のどんなタイミング（例えば <code class="language-plaintext highlighter-rouge">context</code> のプロパティが設定される前）でも発生しうるからです。</p>
  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
  <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_BOT_TOKEN</span><span class="p">,</span>
  <span class="na">extendedErrorHandler</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="k">async</span> <span class="p">({</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">body</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Bolt で指定した logger を使ってエラー内容をログ出力</span>
  <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">teamId</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// デバッグのために teamId を使ってなんらかの処理</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="authorization">認可（Authorization）</h3>

            <div class="section-content">
  <p>認可（Authorization）は、Slack からのリクエストを処理するにあたって、どの Slack クレデンシャル (ボットトークンなど) を使用可能にするかを決定するプロセスです。</p>

  <p>1 つだけのワークスペースにインストールされたカスタムアプリであれば <code class="language-plaintext highlighter-rouge">App</code> 初期化時に単に <code class="language-plaintext highlighter-rouge">token</code> オプションを使用するだけで OK です。一方で、複数のワークスペースにインストールされる、複数のユーザートークンを使用するといったケースのように、アプリが複数のトークンを処理しなければならない場合があります。このようなケースでは <code class="language-plaintext highlighter-rouge">token</code> の代わりに <code class="language-plaintext highlighter-rouge">authorize</code> オプションを使用する必要があります。</p>

  <p><code class="language-plaintext highlighter-rouge">authorize</code> オプションには、イベントソースを入力値として受け取り、許可された認可されたクレデンシャルを含むオブジェクトを Promise の値として返す関数を指定します。このイベントソースの情報には、 <code class="language-plaintext highlighter-rouge">teamId</code> (常に存在します)、 <code class="language-plaintext highlighter-rouge">userId</code>、<code class="language-plaintext highlighter-rouge">conversationId</code>、<code class="language-plaintext highlighter-rouge">enterpriseId</code> のような、リクエストが誰によって発生させられたか、どこで発生したかに関する情報が含まれます。</p>

  <p>許可されたクレデンシャルには、<code class="language-plaintext highlighter-rouge">botToken</code>、<code class="language-plaintext highlighter-rouge">userToken</code>、<code class="language-plaintext highlighter-rouge">botId</code> (アプリがボット自体からのメッセージを無視するために必要です)、 <code class="language-plaintext highlighter-rouge">botUserId</code> が含まれます。<a href="#context"><code class="language-plaintext highlighter-rouge">context</code></a> オブジェクトに、これ以外の他のプロパティを自由に設定することもできます。</p>

  <p><code class="language-plaintext highlighter-rouge">botToken</code> と <code class="language-plaintext highlighter-rouge">userToken</code> は、どちらか、またはその両方を必ず設定してください。<code class="language-plaintext highlighter-rouge">say()</code> のようなユーティリティを動作させるには、どちらか一方が存在している必要があります。両方指定した場合、<code class="language-plaintext highlighter-rouge">say()</code> では <code class="language-plaintext highlighter-rouge">botToken</code> が優先されます。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span> <span class="na">authorize</span><span class="p">:</span> <span class="nx">authorizeFn</span><span class="p">,</span> <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span> <span class="p">});</span>

<span class="c1">// 注: これはデモの目的のみの例です</span>
<span class="c1">// 実際は重要なデータはセキュリティの高いデータベースに保存してください。このアプリは bot トークンのみを使用すると仮定しています。ここで使われるオブジェクトは、複数ワークスペースにアプリをインストールした場合のクレデンシャルを保管するモデルです。</span>

<span class="kd">const</span> <span class="nx">installations</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">enterpriseId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">E1234A12AB</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">teamId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">T12345</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">botToken</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xoxb-123abc</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">botId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">B1251</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">botUserId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">U12385</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">teamId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">T77712</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">botToken</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xoxb-102anc</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">botId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">B5910</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">botUserId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">U1239</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">];</span>

<span class="kd">const</span> <span class="nx">authorizeFn</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">teamId</span><span class="p">,</span> <span class="nx">enterpriseId</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// データベースから team（ワークスペース）を取得</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">team</span> <span class="k">of</span> <span class="nx">installations</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// installations 配列から teamId と enterpriseId（Enterprise Grid の OrG の ID）が一致するかチェック</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">team</span><span class="p">.</span><span class="nx">teamId</span> <span class="o">===</span> <span class="nx">teamId</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">team</span><span class="p">.</span><span class="nx">enterpriseId</span> <span class="o">===</span> <span class="nx">enterpriseId</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 一致したワークスペースのクレデンシャルを使用</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="c1">// 代わりに userToken をセットしても OK</span>
        <span class="na">botToken</span><span class="p">:</span> <span class="nx">team</span><span class="p">.</span><span class="nx">botToken</span><span class="p">,</span>
        <span class="na">botId</span><span class="p">:</span> <span class="nx">team</span><span class="p">.</span><span class="nx">botId</span><span class="p">,</span>
        <span class="na">botUserId</span><span class="p">:</span> <span class="nx">team</span><span class="p">.</span><span class="nx">botUserId</span>
      <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">No matching authorizations</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="token-rotation">トークンのローテーション</h3>

            <div class="section-content">
  <p>Bolt for JavaScript <a href="https://github.com/slackapi/bolt-js/releases/tag/%40slack%2Fbolt%403.5.0">v3.5.0</a> から、アクセストークンのさらなるセキュリティ強化のレイヤーであるトークンローテーションの機能に対応しています。トークンローテーションは <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-10.4">OAuth V2 の RFC</a> で規定されているものです。</p>

  <p>既存の Slack アプリではアクセストークンが無期限に存在し続けるのに対して、トークンローテーションを有効にしたアプリではアクセストークンが失効するようになります。リフレッシュトークンを利用して、アクセストークンを長期間にわたって更新し続けることができます。</p>

  <p><a href="https://slack.dev/bolt-js/ja-jp/concepts#authenticating-oauth">Bolt for JavaScript の組み込みの OAuth 機能</a> を使用していれば、Bolt for JavaScript が自動的にトークンローテーションの処理をハンドリングします。</p>

  <p>トークンローテーションに関する詳細は <a href="https://api.slack.com/authentication/rotation">API ドキュメント</a>を参照してください。</p>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="conversation-store">会話ストア</h3>

            <div class="section-content">
  <p>Bolt は、会話 (conversation) に関連する state を設定および取得する store をサポートしています。conversation store には以下の 2 つのメソッドがあります。</p>
  <ul>
    <li>
<code class="language-plaintext highlighter-rouge">set()</code> は会話の state を変更します。<code class="language-plaintext highlighter-rouge">set()</code> は、文字列型の <code class="language-plaintext highlighter-rouge">conversationId</code>、任意の型の <code class="language-plaintext highlighter-rouge">value</code>、およびオプションの数値型の <code class="language-plaintext highlighter-rouge">expiresAt</code> を必要とします。<code class="language-plaintext highlighter-rouge">set()</code> は <code class="language-plaintext highlighter-rouge">Promise</code> を返します。</li>
    <li>
<code class="language-plaintext highlighter-rouge">get()</code> は store から会話の state を取得します。<code class="language-plaintext highlighter-rouge">get()</code> は文字列型の <code class="language-plaintext highlighter-rouge">conversationId</code> を必要とし、その会話の state とともに Promise を返します。</li>
  </ul>

  <p><code class="language-plaintext highlighter-rouge">conversationContext()</code> は、他のミドルウェアによる会話の更新を可能にする組み込みの<a href="#global-middleware">グローバルミドルウェア</a>です。イベントを受け取ると、ミドルウェア関数は <code class="language-plaintext highlighter-rouge">context.updateConversation()</code> を使用して状態を設定でき、<code class="language-plaintext highlighter-rouge">context.conversation</code> を使用してその state を取得できます。</p>

  <p>組み込みの conversation store は、シンプルに会話の state をメモリーに格納します。状況によってはこれで十分ですが、アプリのインスタンスが複数実行されている場合、状態はプロセス間で共有されないため、データベースを使用して会話の state を取得する conversation store を実装することをおすすめします。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="nx">token</span><span class="p">,</span>
  <span class="nx">signingSecret</span><span class="p">,</span>
  <span class="c1">// クラスを作成する感じで</span>
  <span class="na">convoStore</span><span class="p">:</span> <span class="k">new</span> <span class="nx">simpleConvoStore</span><span class="p">()</span>
<span class="p">});</span>

<span class="c1">// Firebaseのようなデータベースを使い conversation store を実装</span>
<span class="kd">class</span> <span class="nx">simpleConvoStore</span> <span class="p">{</span>
  <span class="kd">set</span><span class="p">(</span><span class="nx">conversationId</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">expiresAt</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Promise を返す</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="dl">'</span><span class="s1">conversations/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">conversationId</span><span class="p">).</span><span class="kd">set</span><span class="p">({</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">expiresAt</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">get</span><span class="p">(</span><span class="nx">conversationId</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Promise を返す</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="dl">'</span><span class="s1">conversations/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">conversationId</span><span class="p">).</span><span class="nx">once</span><span class="p">(</span><span class="dl">'</span><span class="s1">value</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">expiresAt</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">expiresAt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="dl">'</span><span class="s1">conversations/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">conversationId</span><span class="p">).</span><span class="k">delete</span><span class="p">();</span>

            <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Conversation expired</span><span class="dl">'</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// Conversation が存在しないエラー</span>
          <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Conversation not found</span><span class="dl">'</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="global-middleware">グローバルミドルウェア</h3>

            <div class="section-content">
  <p>グローバルミドルウェアは、すべての受信リクエストに対して、リスナーミドルウェアより前に実行されます。<code class="language-plaintext highlighter-rouge">app.use(fn({payload,...,next}))</code> を使用すると、グローバルミドルウェアをいくつでもアプリに追加できます。</p>

  <p>グローバルミドルウェアとリスナーミドルウェアは、いずれも、<code class="language-plaintext highlighter-rouge">await next()</code> を呼び出して実行チェーンの制御を次のミドルウェアに渡すか、<code class="language-plaintext highlighter-rouge">throw</code> を呼び出して以前に実行したミドルウェアチェーンにエラーを渡す必要があります。</p>

  <p>たとえば、アプリが、対応する内部認証サービス (SSO プロバイダ、LDAP など) で識別されたユーザーにのみ応答する必要があるとします。この場合、グローバルミドルウェアを使用して認証サービス内のユーザーレコードを検索し、ユーザーが見つからない場合はエラーとなるように定義するのがよいでしょう。</p>

  <p><em>注: Bolt 2.x からグローバルミドルウェアが <code class="language-plaintext highlighter-rouge">async</code> 関数をサポートしました！この変更については <a href="https://slack.dev/bolt/ja-jp/tutorial/migration-v2">2.x マイグレーションガイド</a>を参照してください。</em></p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td>
<td class="rouge-code"><pre><span class="c1">//  Acme ID情報管理プロバイダ上のユーザからの着信リクエストと紐つけた認証ミドルウェア</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">authWithAcme</span><span class="p">({</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">next</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">slackUserId</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">helpChannelId</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">C12345</span><span class="dl">'</span><span class="p">;</span>

  <span class="c1">// Slack ユーザ ID を使って Acmeシステム上にあるユーザ情報を検索できる関数があるとと仮定</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">acme</span><span class="p">.</span><span class="nx">lookupBySlackId</span><span class="p">(</span><span class="nx">slackUserId</span><span class="p">)</span>
    
    <span class="c1">// 検索できたらそのユーザ情報でコンテクストを生成</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Acme システム上にユーザが存在しないパターン。エラーを伝えることとし、リクエストの処理は継続しない</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Not Found</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">postEphemeral</span><span class="p">({</span>
          <span class="na">channel</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">channel</span><span class="p">,</span>
          <span class="na">user</span><span class="p">:</span> <span class="nx">slackUserId</span><span class="p">,</span>
          <span class="na">text</span><span class="p">:</span> <span class="s2">`Sorry &lt;@</span><span class="p">${</span><span class="nx">slackUserId</span><span class="p">}</span><span class="s2">&gt;, you aren't registered in Acme. Please post in &lt;#</span><span class="p">${</span><span class="nx">helpChannelId</span><span class="p">}</span><span class="s2">&gt; for assistance.`</span>
        <span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// 制御とリスナー関数を（もしあれば）前のミドルウェア渡す、もしくはグローバルエラーハンドラに引き渡し</span>
      <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">// 制御とリスナー関数を次のミドルウェアに引き渡し</span>
  <span class="k">await</span> <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="listener-middleware">リスナーミドルウェア</h3>

            <div class="section-content">
  <p>リスナーミドルウェアは、多くのリスナー関数を対象（つまり、複数のリスナー関数を対象としますが、全てのリスナーに実行するわけではないものです）としたロジックの適用に使用でき、リスナーを追加する組み込みメソッドの引数リスト内で、リスナー関数より先に引数として追加されます。ここでは任意の数のリスナーミドルウェアを追加することができます。</p>

  <p>組み込みリスナーミドルウェアはいくつか用意されており、例えば、メッセージのサブタイプをフィルタリングする <code class="language-plaintext highlighter-rouge">subtype()</code> や、メッセージのはじまりでボットに直接 @ メンションしないメッセージを除外する <code class="language-plaintext highlighter-rouge">directMention()</code> のように使用することができます。</p>

  <p>もちろん、よりカスタマイズされた機能を追加するために独自のミドルウェアを実装することもできます。カスタムミドルウェアとして動作する関数の実装は <code class="language-plaintext highlighter-rouge">await next()</code> を呼び出して制御を次のミドルウェアに渡すか、<code class="language-plaintext highlighter-rouge">throw</code> を呼び出して以前に実行されたミドルウェアチェーンにエラーを投げる必要があります。</p>

  <p>例として、リスナーが人（ボットではないユーザー）からのメッセージのみを扱うケースを考えてみましょう。このためには、全てのボットメッセージを除外するリスナーミドルウェアを実装します。</p>

  <p><em>注: Bolt 2.x からミドルウェアが <code class="language-plaintext highlighter-rouge">async</code> 関数をサポートしました！この変更については <a href="https://slack.dev/bolt/ja-jp/tutorial/migration-v2">2.x マイグレーションガイド</a>を参照してください。</em></p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
<td class="rouge-code"><pre><span class="c1">// 'bot_message' サブタイプを持つメッセージをフィルタリングするリスナーミドルウェア</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">noBotMessages</span><span class="p">({</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">next</span> <span class="p">})</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">||</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">bot_message</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ボットではなく人間からのメッセージのみを受信するリスナー</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="nx">noBotMessages</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span>
  <span class="c1">// 新規で投稿されたメッセージのみを処理</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">===</span> <span class="kc">undefined</span>
    <span class="c1">// || message.subtype === 'bot_message'</span>
    <span class="o">||</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">file_share</span><span class="dl">'</span>
    <span class="o">||</span> <span class="nx">message</span><span class="p">.</span><span class="nx">subtype</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">thread_broadcast</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`(MSG) User: </span><span class="p">${</span><span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="s2"> Message: </span><span class="p">${</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">));</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="context">context の追加</h3>

            <div class="section-content">
  <p><code class="language-plaintext highlighter-rouge">context</code> オブジェクトは、受信リクエストに付加情報を提供するために使用されるもので、全てのリスナーがこれを使用できます。例えば、3rd party のシステムからユーザー情報を追加したり、ミドルウェアのチェインの中で次のミドルウェアが必要とする一時的な状態を追加したりといった用途に利用できます。</p>

  <p><code class="language-plaintext highlighter-rouge">context</code> は、ただのオブジェクトなので、いくらでも属性を追加、編集することができます。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td>
<td class="rouge-code"><pre><span class="k">async</span> <span class="kd">function</span> <span class="nx">addTimezoneContext</span><span class="p">({</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">next</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">info</span><span class="p">({</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">user_id</span><span class="p">,</span>
    <span class="na">include_locale</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">});</span>

  <span class="c1">// ユーザのタイムゾーン情報を追加</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">tz_offset</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">tz_offset</span><span class="p">;</span>

  <span class="c1">// 制御とリスナー関数を次のミドルウェアに引き渡し</span>
  <span class="k">await</span> <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">command</span><span class="p">(</span><span class="dl">'</span><span class="s1">/request</span><span class="dl">'</span><span class="p">,</span> <span class="nx">addTimezoneContext</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">command</span><span class="p">,</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">logger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// コマンドリクエストの確認</span>
  <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>
  <span class="c1">// リクエスト時のローカル時間を取得</span>
  <span class="kd">const</span> <span class="nx">localHour</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span> <span class="o">+</span> <span class="nx">context</span><span class="p">.</span><span class="nx">tz_offset</span><span class="p">).</span><span class="nx">getHours</span><span class="p">();</span>

  <span class="c1">// リクエストに使用するチャンネル ID</span>
  <span class="kd">const</span> <span class="nx">requestChannel</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">C12345</span><span class="dl">'</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">requestText</span> <span class="o">=</span> <span class="s2">`:large_blue_circle: *New request from &lt;@</span><span class="p">${</span><span class="nx">command</span><span class="p">.</span><span class="nx">user_id</span><span class="p">}</span><span class="s2">&gt;*: </span><span class="p">${</span><span class="nx">command</span><span class="p">.</span><span class="nx">text</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

  <span class="c1">// 午前 9 時〜午後 5 時以外のリクエストの場合は明日</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">localHour</span> <span class="o">&gt;</span> <span class="mi">17</span> <span class="o">||</span> <span class="nx">localHour</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ローカル時間の明日午前 9 時までの差分を取得する関数があると仮定</span>
    <span class="kd">const</span> <span class="nx">localTomorrow</span> <span class="o">=</span> <span class="nx">getLocalTomorrow</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">tz_offset</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// メッセージ送信スケジュールを調整</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">scheduleMessage</span><span class="p">({</span>
        <span class="na">channel</span><span class="p">:</span> <span class="nx">requestChannel</span><span class="p">,</span>
        <span class="na">text</span><span class="p">:</span> <span class="nx">requestText</span><span class="p">,</span>
        <span class="na">post_at</span><span class="p">:</span> <span class="nx">localTomorrow</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// 送信</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
        <span class="na">channel</span><span class="p">:</span> <span class="nx">requestChannel</span><span class="p">,</span>
        <span class="na">text</span><span class="p">:</span> <span class="nx">requestText</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="logging">ログの表示</h3>

            <div class="section-content">
  <p>Bolt はデフォルトの設定では、標準出力のコンソールにログを出力します。どれくらいのログが出力されるかは、コンストラクターの引数の <code class="language-plaintext highlighter-rouge">logLevel</code> を指定して、カスタマイズできます。使用可能なログレベルは、頻度の高い方から順に、<code class="language-plaintext highlighter-rouge">DEBUG</code>、<code class="language-plaintext highlighter-rouge">INFO</code>、<code class="language-plaintext highlighter-rouge">WARN</code>、<code class="language-plaintext highlighter-rouge">ERROR</code> です。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="c1">// パッケージから LogLevel をインポート</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">LogLevel</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// オプションとして、コンストラクタで Log level を設定可能</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="nx">token</span><span class="p">,</span>
  <span class="nx">signingSecret</span><span class="p">,</span>
  <span class="na">logLevel</span><span class="p">:</span> <span class="nx">LogLevel</span><span class="p">.</span><span class="nx">DEBUG</span><span class="p">,</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">コンソール以外へのログ出力の送信</h4>
  </summary>

  <div class="secondary-content">
    <p>ログの送信先をコンソール以外に設定したり、よりロガーを細かくコントロールしたい場合は、カスタムロガーを実装します。カスタムロガーは、以下のメソッド (<code class="language-plaintext highlighter-rouge">Logger</code> インターフェイスに定義されているもの) を実装する必要があります。</p>

    <table>
      <thead>
        <tr>
          <th>メソッド</th>
          <th>パラメーター</th>
          <th>戻り値の型</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">setLevel()</code></td>
          <td><code class="language-plaintext highlighter-rouge">level: LogLevel</code></td>
          <td><code class="language-plaintext highlighter-rouge">void</code></td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">getLevel()</code></td>
          <td>なし</td>
          <td>
<code class="language-plaintext highlighter-rouge">string</code> (値は <code class="language-plaintext highlighter-rouge">error</code>, <code class="language-plaintext highlighter-rouge">warn</code>, <code class="language-plaintext highlighter-rouge">info</code>, <code class="language-plaintext highlighter-rouge">debug</code> のいずれか)</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">setName()</code></td>
          <td><code class="language-plaintext highlighter-rouge">name: string</code></td>
          <td><code class="language-plaintext highlighter-rouge">void</code></td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">debug()</code></td>
          <td><code class="language-plaintext highlighter-rouge">...msgs: any[]</code></td>
          <td><code class="language-plaintext highlighter-rouge">void</code></td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">info()</code></td>
          <td><code class="language-plaintext highlighter-rouge">...msgs: any[]</code></td>
          <td><code class="language-plaintext highlighter-rouge">void</code></td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">warn()</code></td>
          <td><code class="language-plaintext highlighter-rouge">...msgs: any[]</code></td>
          <td><code class="language-plaintext highlighter-rouge">void</code></td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">error()</code></td>
          <td><code class="language-plaintext highlighter-rouge">...msgs: any[]</code></td>
          <td><code class="language-plaintext highlighter-rouge">void</code></td>
        </tr>
      </tbody>
    </table>

    <p>非常に単純なカスタム logger では、名前やレベルが無視され、すべてのメッセージがファイルに書き込まれることがあります。</p>
  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">createWriteStream</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">logWritable</span> <span class="o">=</span> <span class="nx">createWriteStream</span><span class="p">(</span><span class="dl">'</span><span class="s1">/var/my_log_file</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="nx">token</span><span class="p">,</span>
  <span class="nx">signingSecret</span><span class="p">,</span>
  <span class="c1">// リテラルオブジェクトとして logger を設定（必要なメソッドを持つクラスを指定するイメージで）</span>
  <span class="na">logger</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">debug</span><span class="p">:</span> <span class="p">(...</span><span class="nx">msgs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">logWritable</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">debug: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">msgs</span><span class="p">));</span> <span class="p">},</span>
    <span class="na">info</span><span class="p">:</span> <span class="p">(...</span><span class="nx">msgs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">logWritable</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">info: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">msgs</span><span class="p">));</span> <span class="p">},</span>
    <span class="na">warn</span><span class="p">:</span> <span class="p">(...</span><span class="nx">msgs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">logWritable</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">warn: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">msgs</span><span class="p">));</span> <span class="p">},</span>
    <span class="na">error</span><span class="p">:</span> <span class="p">(...</span><span class="nx">msgs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">logWritable</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">msgs</span><span class="p">));</span> <span class="p">},</span>
    <span class="na">setLevel</span><span class="p">:</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">},</span>
    <span class="na">getLevel</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">},</span>
    <span class="na">setName</span><span class="p">:</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">},</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>

</details>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="receiver">レシーバーのカスタマイズ</h3>

            <div class="section-content">
  <p>レシーバーは、Slack からのイベントを受け付けてパースした後、それを Bolt アプリに伝える責務を担っています。Bolt アプリは、<code class="language-plaintext highlighter-rouge">context</code> 情報やリスナーへのイベントの引き渡しを行います。レシーバーの実装は <code class="language-plaintext highlighter-rouge">Receiver</code> インターフェイスに準拠している必要があります。</p>

  <table>
    <thead>
      <tr>
        <th>メソッド</th>
        <th>パラメーター</th>
        <th>戻り値の型</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">init()</code></td>
        <td><code class="language-plaintext highlighter-rouge">app: App</code></td>
        <td><code class="language-plaintext highlighter-rouge">unknown</code></td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">start()</code></td>
        <td>None</td>
        <td><code class="language-plaintext highlighter-rouge">Promise</code></td>
      </tr>
      <tr>
        <td><code class="language-plaintext highlighter-rouge">stop()</code></td>
        <td>None</td>
        <td><code class="language-plaintext highlighter-rouge">Promise</code></td>
      </tr>
    </tbody>
  </table>

  <p><code class="language-plaintext highlighter-rouge">init()</code> メソッドは Bolt for JavaScript アプリが生成されたときに呼び出されます。このメソッドはレシーバーに <code class="language-plaintext highlighter-rouge">App</code> インスタンスへの参照を与えます。レシーバーはこれを保持して、イベント受信時に呼び出します。</p>

  <ul>
    <li>
<code class="language-plaintext highlighter-rouge">await app.processEvent(event)</code> は Slack から送信されてくるイベントを受け取るたびに呼び出されます。ハンドリングされなかったエラーが発生した場合はそれを throw します。</li>
  </ul>

  <p>カスタムのレシーバーを使用する場合は、それを <code class="language-plaintext highlighter-rouge">App</code> のコンストラクターに渡します。ここで紹介しているコード例は、基本的なカスタムレシーバーの実装例です。</p>

  <p>レシーバーについてより深く知りたい場合は、<a href="https://github.com/slackapi/bolt-js/blob/master/src/ExpressReceiver.ts">組み込み <code class="language-plaintext highlighter-rouge">ExpressReceiver</code> のソースコード</a>を参照してください。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td>
<td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">EventEmitter</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">events</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createServer</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// EventEmitter は on() 関数を操作</span>
<span class="c1">// https://nodejs.org/api/events.html#events_emitter_on_eventname_listener</span>
<span class="kd">class</span> <span class="nx">simpleReceiver</span> <span class="kd">extends</span> <span class="nx">EventEmitter</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">signingSecret</span><span class="p">,</span> <span class="nx">endpoints</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">server</span> <span class="o">=</span> <span class="nx">createServer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">endpoint</span> <span class="k">of</span> <span class="nx">endpoints</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">requestHandler</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">init</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bolt</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">start</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">stop</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">resolve</span><span class="p">();</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">requestHandler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">ackCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="c1">// 着信リクエストをパースするparseBody 関数があると仮定</span>
    <span class="kd">const</span> <span class="nx">parsedReq</span> <span class="o">=</span> <span class="nx">parseBody</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">event</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">parsedReq</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
      <span class="c1">// レシーバーが確認作業に重要</span>
      <span class="na">ack</span><span class="p">:</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ackCalled</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">''</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="nx">ackCalled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">bolt</span><span class="p">.</span><span class="nx">processEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>


            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="custom-routes">カスタム HTTP ルートの追加</h3>

            <div class="section-content">
  <p><code class="language-plaintext highlighter-rouge">v3.7.0</code> から <code class="language-plaintext highlighter-rouge">App</code> を初期化する際に <code class="language-plaintext highlighter-rouge">customRoutes</code> というルートの配列を渡すことでカスタムの HTTP ルートを簡単に追加できるようになりました。</p>

  <p>各 <code class="language-plaintext highlighter-rouge">CustomRoute</code> オブジェクトには <code class="language-plaintext highlighter-rouge">path</code> 、 <code class="language-plaintext highlighter-rouge">method</code>、 <code class="language-plaintext highlighter-rouge">handler</code> という三つのプロパティが含まれていなければなりません。 HTTP メソッドに相当する <code class="language-plaintext highlighter-rouge">method</code> は文字列または文字列の配列です。</p>

  <p><code class="language-plaintext highlighter-rouge">v3.13.0</code> からデフォルトの組み込みレシーバーである <code class="language-plaintext highlighter-rouge">HTTPReceiver</code> と <code class="language-plaintext highlighter-rouge">SocketModeReceiver</code> が、<a href="https://expressjs.com/en/guide/routing.html#route-parameters">Express.js</a> が提供するものと同様な動的なルートパラメーターをサポートするようになりました。これによって URL 内に含まれる値を <code class="language-plaintext highlighter-rouge">req.params</code> の値として利用できるようになりました。</p>

  <p>カスタムの HTTP ルートがローカル環境でどのポートからアクセスできるかを指定するために <code class="language-plaintext highlighter-rouge">App</code> コンストラクターに <code class="language-plaintext highlighter-rouge">installerOptions.port</code> というプロパティを渡すことができます。指定しない場合は、デフォルトの <code class="language-plaintext highlighter-rouge">3000</code> ポートとなります。</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// デフォルトの HTTPReceiver を使って Bolt アプリを初期化します</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_BOT_TOKEN</span><span class="p">,</span>
  <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
  <span class="na">customRoutes</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/health-check</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">method</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">handler</span><span class="p">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">`Things are going just fine at </span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span><span class="p">}</span><span class="s2">!`</span><span class="p">);</span>
      <span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/music/:genre</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">method</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">handler</span><span class="p">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">`Oh? </span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">genre</span><span class="p">}</span><span class="s2">? That slaps!`</span><span class="p">);</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">],</span>
  <span class="na">installerOptions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">3001</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">⚡️ Bolt app started</span><span class="dl">'</span><span class="p">);</span>
<span class="p">})();</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

<details class="secondary-wrapper">
  <summary class="section-head">
    <h4 class="section-head">カスタム ExpressReceiver ルート</h4>
  </summary>

  <div class="secondary-content">
    <p>Bolt の組み込みの <code class="language-plaintext highlighter-rouge">ExpressReceiver</code> を使っているなら、カスタムの HTTP ルートを追加するのはとても簡単です。<code class="language-plaintext highlighter-rouge">v2.1.0</code> から <code class="language-plaintext highlighter-rouge">ExpressReceiver</code> には <code class="language-plaintext highlighter-rouge">router</code> というプロパティが追加されています。これは、さらにルートを追加できるように <code class="language-plaintext highlighter-rouge">App</code> 内部で保持している Express の <a href="http://expressjs.com/en/4x/api.html#router">Router</a> を public にしたものです。</p>
  </div>

  <div class="language-javascript highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">ExpressReceiver</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Bolt の Receiver を明に生成</span>
<span class="kd">const</span> <span class="nx">receiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExpressReceiver</span><span class="p">({</span> <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span> <span class="p">});</span>

<span class="c1">// App をこのレシーバーを指定して生成</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_BOT_TOKEN</span><span class="p">,</span>
  <span class="nx">receiver</span>
<span class="p">});</span>

<span class="c1">// Slack とのやりとりは App のメソッドで定義</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">client</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Do some slack-specific stuff here</span>
  <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(...);</span>
<span class="p">});</span>

<span class="nx">receiver</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Request time: </span><span class="p">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()}</span><span class="s2">`</span><span class="p">);</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="c1">// それ以外の Web リクエストの処理は receiver.router のメソッドで定義</span>
<span class="nx">receiver</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/secret-page</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ここでは Express のリクエストやレスポンスをそのまま扱う</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">yay!</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">⚡️ Bolt app started</span><span class="dl">'</span><span class="p">);</span>
<span class="p">})();</span>
</pre></td>
</tr></tbody></table></code></pre>
    </div>
  </div>
</details>


            <hr>
          </div>
          
        </div>

        <div id="steps">
           
          <div class="section-wrapper">
            <h3 id="steps-overview">
              ワークフローステップの概要
              <span class="label-deprecated">
                非推奨
              </span>
            </h3>
            <div class="section-content">
  <p>（アプリによる）ワークフローステップ（Workflow Steps from Apps) は、<a href="https://api.slack.com/workflows">ワークフロービルダー</a>におけるワークフローに組み込み可能なカスタムのワークフローステップを任意の Slack アプリが提供することを可能とします。</p>

  <p>ワークフローステップは、三つの異なるユーザーイベントから構成されます:</p>

  <ul>
    <li>ワークフロー作成者がワークフローにカスタムステップを追加・または編集する</li>
    <li>ワークフロー作成者がステップの設定を保存・更新する</li>
    <li>ワークフローの利用者がそのワークフローステップを実行する</li>
  </ul>

  <p>ワークフローステップを機能させるためには、これら三つのイベント全てを適切にハンドリングする必要があります。</p>

  <p>ワークフローステップのさらなる詳細については <a href="https://api.slack.com/workflows/steps">API ドキュメント</a>を参考にしてください。</p>

</div>

            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="creating-steps">
              ステップの定義
              <span class="label-deprecated">
                非推奨
              </span>
            </h3>
            <div class="section-content">

  <p>ワークフローステップを作るための手段として Bolt は <code class="language-plaintext highlighter-rouge">WorkflowStep</code> というクラスを提供しています。</p>

  <p>新しい <code class="language-plaintext highlighter-rouge">WorkflowStep</code> インスタンスの生成には、そのステップの <code class="language-plaintext highlighter-rouge">callback_id</code> と設定オブジェクトを渡します。</p>

  <p>設定オブジェクトには <code class="language-plaintext highlighter-rouge">edit</code>、<code class="language-plaintext highlighter-rouge">save</code>、<code class="language-plaintext highlighter-rouge">execute</code> という三つのプロパティがあります。これらのそれぞれは単一のコールバック関数、またはコールバック関数の配列である必要があります。すべてのコールバック関数は、ワークフローステップのイベントに関する情報を保持しする <code class="language-plaintext highlighter-rouge">step</code> オブジェクトにアクセスすることができます。</p>

  <p><code class="language-plaintext highlighter-rouge">WorkflowStep</code> インスタンスを生成したら、それを <code class="language-plaintext highlighter-rouge">app.step()</code> メソッドに渡します。これによって、Bolt アプリは対象のワークフローステップのイベントをリッスンしたり、設定オブジェクトが提供するコールバック関数を使ってイベントに応答したりすることができるようになります。
</p>
</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">WorkflowStep</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/bolt</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// いつも通り Bolt アプリを初期化</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">({</span>
  <span class="na">signingSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_SIGNING_SECRET</span><span class="p">,</span>
  <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_BOT_TOKEN</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// WorkflowStep インスタンスを生成</span>
<span class="kd">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WorkflowStep</span><span class="p">(</span><span class="dl">'</span><span class="s1">add_task</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">edit</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">configure</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
  <span class="na">save</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">update</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
  <span class="na">execute</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">complete</span><span class="p">,</span> <span class="nx">fail</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">step</span><span class="p">(</span><span class="nx">ws</span><span class="p">);</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="adding-editing-steps">
              ステップの追加・編集
              <span class="label-deprecated">
                非推奨
              </span>
            </h3>
            <div class="section-content">

  <p>ワークフローの作成者が、アプリが提供するステップをワークフローに追加（またはその設定を変更）するタイミングで、アプリは <a href="https://api.slack.com/reference/workflows/workflow_step_edit"><code class="language-plaintext highlighter-rouge">workflow_step_edit</code></a> というイベントを受信します。このイベントの受信時に <code class="language-plaintext highlighter-rouge">WorkflowStep</code> 設定オブジェクト内の <code class="language-plaintext highlighter-rouge">edit</code> コールバック関数が実行されます。</p>

  <p>このとき、ワークフロー作成・変更のどちらの場合でも、アプリは<a href="https://api.slack.com/reference/workflows/configuration-view">ワークフローステップ設定のためのモーダル</a>を応答する必要があります。このモーダルは、ワークフローステップに固有の設定である必要があり、通常のモーダルにはない制約があります。最もわかりやすいものとしては、<code class="language-plaintext highlighter-rouge">title​</code>、<code class="language-plaintext highlighter-rouge">submit​</code>、<code class="language-plaintext highlighter-rouge">close</code> プロパティを設定することができません。また、デフォルトの設定では、この設定モーダルの <code class="language-plaintext highlighter-rouge">callback_id</code> はワークフローステップのものと同じものが使用されます。</p>

  <p><code class="language-plaintext highlighter-rouge">edit</code> コールバック関数の中では モーダルの view のうち <code class="language-plaintext highlighter-rouge">blocks</code> だけを渡すだけで簡単にステップ設定モーダルをオープンすることができる <code class="language-plaintext highlighter-rouge">configure()</code> というユーティリティ関数が利用できます。これは、必要な入力内容が揃うまで設定の保存を無効にする <code class="language-plaintext highlighter-rouge">submit_disabled</code> というオプションを <code class="language-plaintext highlighter-rouge">true</code> に設定します。</p>

  <p>設定モーダルを開く処理に関するさらなる詳細は、<a href="https://api.slack.com/workflows/steps#handle_config_view">ドキュメント</a>を参考にしてください。</p>

</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WorkflowStep</span><span class="p">(</span><span class="dl">'</span><span class="s1">add_task</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">edit</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">configure</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>

    <span class="kd">const</span> <span class="nx">blocks</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">block_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">task_name_input</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">element</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text_input</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">action_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">placeholder</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Add a task name</span><span class="dl">'</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">},</span>
        <span class="na">label</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Task name</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">block_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">task_description_input</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">element</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text_input</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">action_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">description</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">placeholder</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Add a task description</span><span class="dl">'</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">},</span>
        <span class="na">label</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">plain_text</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Task description</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">},</span>
    <span class="p">];</span>

    <span class="k">await</span> <span class="nx">configure</span><span class="p">({</span> <span class="nx">blocks</span> <span class="p">});</span>
  <span class="p">},</span>
  <span class="na">save</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">update</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
  <span class="na">execute</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">complete</span><span class="p">,</span> <span class="nx">fail</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="saving-steps">
              ステップの設定の保存
              <span class="label-deprecated">
                非推奨
              </span>
            </h3>
            <div class="section-content">

  <p>ワークフローステップの設定モーダルが開いたら、アプリはワークフロー作成者がモーダルを送信するイベントである <code class="language-plaintext highlighter-rouge">view_submission</code> イベントを待ち受けます。このイベントを受信すると <code class="language-plaintext highlighter-rouge">WorkflowStep</code> 設定オブジェクト内の <code class="language-plaintext highlighter-rouge">save</code> コールバック関数が実行されます。</p>

  <p><code class="language-plaintext highlighter-rouge">save</code> コールバック関数の中では、以下の引数を渡してステップの設定を保存するための <code class="language-plaintext highlighter-rouge">update()</code> 関数を利用できます。</p>

  <ul>
    <li>
<code class="language-plaintext highlighter-rouge">inputs</code> は、ワークフローステップ実行時にアプリが受け取ることを期待するデータの内容を表現するオブジェクトです</li>
    <li>
<code class="language-plaintext highlighter-rouge">outputs</code> は、ステップの実行が正常に完了したとき、同一ワークフロー内の後続のステップに提供するデータの内容を表現するオブジェクトの配列です。</li>
    <li>
<code class="language-plaintext highlighter-rouge">step_name</code> は、デフォルトのステップ名を上書きするために使用します</li>
    <li>
<code class="language-plaintext highlighter-rouge">step_image_url</code> は、デフォルトのステップのイメージ画像を上書きするために使用します</li>
  </ul>

  <p>これら引数をどのように構成するかの詳細は、<a href="https://api.slack.com/reference/workflows/workflow_step">ドキュメント</a>を参考にしてください。</p>

</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WorkflowStep</span><span class="p">(</span><span class="dl">'</span><span class="s1">add_task</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">edit</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">configure</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
  <span class="na">save</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">update</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">ack</span><span class="p">();</span>

    <span class="kd">const</span> <span class="p">{</span> <span class="nx">values</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">taskName</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">task_name_input</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">taskDescription</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">task_description_input</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span>
                
    <span class="kd">const</span> <span class="nx">inputs</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">taskName</span><span class="p">:</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="nx">taskName</span><span class="p">.</span><span class="nx">value</span> <span class="p">},</span>
      <span class="na">taskDescription</span><span class="p">:</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="nx">taskDescription</span><span class="p">.</span><span class="nx">value</span> <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">const</span> <span class="nx">outputs</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">taskName</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">label</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Task name</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">taskDescription</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">label</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Task description</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">];</span>

    <span class="k">await</span> <span class="nx">update</span><span class="p">({</span> <span class="nx">inputs</span><span class="p">,</span> <span class="nx">outputs</span> <span class="p">});</span>
  <span class="p">},</span>
  <span class="na">execute</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">complete</span><span class="p">,</span> <span class="nx">fail</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

            <hr>
          </div>
          
          <div class="section-wrapper">
            <h3 id="executing-steps">
              ステップの実行
              <span class="label-deprecated">
                非推奨
              </span>
            </h3>
            <div class="section-content">

  <p>ワークフローの利用者によって、アプリが提供するカスタムのワークフローステップが実行されるとき、アプリは<a href="https://api.slack.com/events/workflow_step_execute"><code class="language-plaintext highlighter-rouge">workflow_step_execute</code></a> というイベントを受信します。このイベントの受信時に <code class="language-plaintext highlighter-rouge">WorkflowStep</code> 設定オブジェクト内の <code class="language-plaintext highlighter-rouge">execute</code> コールバック関数が実行されます。</p>

  <p><code class="language-plaintext highlighter-rouge">save</code> コールバック関数で予め規定された <code class="language-plaintext highlighter-rouge">inputs</code> の情報を使って、ここでの処理は、サードパーティの API を呼び出したり、データベースに情報を保存したり、そのユーザーのホームタブを更新したり、<code class="language-plaintext highlighter-rouge">outputs</code> オブジェクトを構築することで後続のワークフローステップが利用できる情報を設定したりします。</p>

  <p><code class="language-plaintext highlighter-rouge">execute</code> コールバック関数内では、ステップの実行が成功であることを Slack 側に伝える <code class="language-plaintext highlighter-rouge">complete()</code> 関数、失敗であることを伝える <code class="language-plaintext highlighter-rouge">fail()</code> 関数のいずれかを呼び出す必要があります。</p>

</div>

<div class="language-javascript highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
<td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WorkflowStep</span><span class="p">(</span><span class="dl">'</span><span class="s1">add_task</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">edit</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">configure</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
  <span class="na">save</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">ack</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">update</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{},</span>
  <span class="na">execute</span><span class="p">:</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">complete</span><span class="p">,</span> <span class="nx">fail</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">inputs</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">step</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">outputs</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">taskName</span><span class="p">:</span> <span class="nx">inputs</span><span class="p">.</span><span class="nx">taskName</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
      <span class="na">taskDescription</span><span class="p">:</span> <span class="nx">inputs</span><span class="p">.</span><span class="nx">taskDescription</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="c1">// もし全て OK なら</span>
    <span class="k">await</span> <span class="nx">complete</span><span class="p">({</span> <span class="nx">outputs</span> <span class="p">});</span>
    <span class="c1">// 注意: processBeforeResponse: true を指定している場合</span>
    <span class="c1">// ここでは await complete() はおすすめしません。呼び出す API の応答が遅いためです。</span>
    <span class="c1">// これにより、3 秒以内に Slack のイベント API に応答することができなくなる場合があります。</span>
    <span class="c1">// 代わりに以下のようにすることができます:</span>
    <span class="c1">// complete({ outputs }).then(() =&gt; { console.log('workflow step execution complete registered'); });</span>

    <span class="c1">// もし何か問題が起きたら</span>
    <span class="c1">// fail({ error: { message: "Just testing step failure!" } }).then(() =&gt; { console.log('workflow step execution failure registered'); });</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></pre>
  </div>
</div>

            <hr>
          </div>
          
        </div>

      </div>
    </div>
    
<script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-56978219-13', 'auto');
  ga('send', 'pageview');
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>

  </body>
</html>
